X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.1
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.1
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
s1fitDf1
fitDf1
dt <- readRDS("./prepped_dt.rds")
dt$MVPA_2 <- dt$MVPA_min_PA2 /20
dt$MVPA_1 <- dt$`MVPA min/week`/ 20
f_cov <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish` + `Type II Diabetes` + `Body Mass Index`"
f_cov_noMediator <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish`"
f_stroke <-   "Surv(`Follow_up time`,`Myocardial Infarction`)"
f_MI <- "Surv(`Follow_up time`,`Stroke`)"
fitDf1 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_1 + ",  f_cov)), data = dt)
tb1<- tbl_regression(fitDf1, exponentiate = TRUE)
fitDf2 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_2 + ",  f_cov)), data = dt)
tb2<- tbl_regression(fitDf2, exponentiate = TRUE)
fitDf1
f_cov <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish` + `Type II Diabetes` + `Body Mass Index`"
f_cov_noMediator <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish`"
f_stroke <-   "Surv(`Follow_up time`,`Myocardial Infarction`)"
f_MI <- "Surv(`Follow_up time`,`Stroke`)"
fitDf1 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_1 + ",  f_cov)), data = dt)
tb1<- tbl_regression(fitDf1, exponentiate = TRUE)
fitDf2 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_2 + ",  f_cov)), data = dt)
tb2<- tbl_regression(fitDf2, exponentiate = TRUE)
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
f_cov <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish` + `Type II Diabetes` + `Body Mass Index`"
f_cov_noMediator <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish`"
f_stroke <-   "Surv(`Follow_up time`,`Myocardial Infarction`)"
f_MI <- "Surv(`Follow_up time`,`Stroke`)"
fitDf1 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_1 + ",  f_cov)), data = dt)
tb1<- tbl_regression(fitDf1, exponentiate = TRUE)
fitDf2 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_2 + ",  f_cov)), data = dt)
tb2<- tbl_regression(fitDf2, exponentiate = TRUE)
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
dtS <- dt %>%
#filter(Sex == "Female") %>%
filter(dt$`Deprivation index`  == "Quarter 4") %>%
dplyr::select(MVPA_1)
#dtS$MVPA_1 <- scale(dtS$MVPA_1)
dim(dtS)
s1 <- sim.survdata(
T = 150,
X=dtS,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1$betas; exp(s1$betas)
s1$data$failed %>% summary()
s1$data$y %>% summary()
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = s1$data)
#fsim <- coxph(Surv(y,failed) ~ X1 + X2 + X3, data = s1$data)
data.frame(fsim$coefficients, confint(fsim))
dim(dtS)
dt$Education
dt$Education %>%  table
dt$`Household Income`
dt$`Household Income` %>% table
s1 <- sim.survdata(
T = 150,
X=dt,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1 <- sim.survdata(
T = 150,
X=dt$MVPA_1,
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 1#,
#beta = c(0.2, -0.2, -0.3),
#mu = 100, sd = 50
,beta = -0.02
)
dts <- list()
dts <- list()
dts[[1]] <- s1 %>% filter(Sex == "Female")
fitDf1 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_1 + ",  f_cov)), data = dt)
fitDf1
fitDf1$coefficients
coefEst <- fitDf1$coefficients
coefEst <- fitDf1$coefficients
fitDf1$linear.predictors
fitDf1 %>% str
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
#num.data.frames = 1#,
#beta = coefEst,
beta = -0.02
)
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
#num.data.frames = 1#,
#beta = coefEst,
beta = -0.02
)
dt$Sex == "Female"
dts[[1]] <- s1$data[dt$Sex == "Female", ]
dim(dts)
dim[dts]
dim(dts[[1]])
dts <- list()
dts[[1]] <- s1$data[dt$Sex == "Female", ]
dts[[2]] <- s1$data[dt$`Deprivation index`  == "Quarter 4", ]
dts[[3]] <- s1$data[dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above", ]
dts[[4]] <- s1$data[dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999", ]
dim(dtS)
dim(dtS[[1]])
dts <- list()
dts[[1]] <- s1$data[dt$Sex == "Female", ]
dts[[2]] <- s1$data[dt$`Deprivation index`  == "Quarter 4", ]
dts[[3]] <- s1$data[dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above", ]
dts[[4]] <- s1$data[dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999", ]
dim(dtS[[1]])
s1$data[dt$Sex == "Female", ]
s1$data[dt$Sex == "Female", ] %>% dim
dim(dts[[1]])
dim(dts[[2]])
system.time()
libraray(timetaken())
?timetaken
started.at=proc.time()
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 5,
#beta = coefEst,
beta = -0.02
)
cat("Finished in",timetaken(started.at),"\n")
saveRDS(s1, "sim/simDataHR.rds")
started.at=proc.time()
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 10,
#beta = coefEst,
beta = -0.02
)
cat("Finished in",timetaken(started.at),"\n")
saveRDS(s1, "sim/simDataHR.rds")
s
str(s1)
s1$data[[1]]
s1$data %>% str
s1[[1]]
s1$data[[1]]$data
s1$data[[1]] %>% names
s1$data[[1]]
s1$data[[1]]
s1$data
s1[[1]]
s1$data[[1]]
s1[[1]]$data
dt$Sex == "Female", ]
dt$Sex == "Female"
indSex <- dt$Sex == "Female"
ind[[1]] <- dt$Sex == "Female"
ind[[2]] <- dt$`Deprivation index`  == "Quarter 4"
ind[[3]] <- dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above"
inc <- list()
ind[[1]] <- dt$Sex == "Female"
ind[[2]] <- dt$`Deprivation index`  == "Quarter 4"
ind[[3]] <- dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above"
ind[[3]] <- dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999"
ind <- list()
ind[[1]] <- dt$Sex == "Female"
ind[[2]] <- dt$`Deprivation index`  == "Quarter 4"
ind[[3]] <- dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above"
ind[[3]] <- dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999"
ind[[4]] <- dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999"
ind[[4]]
ind[[4]]
ind[[3]]
Ums(ind[[4]])
sum(ind[[4]])
sum(ind[[3]])
sum(ind[[2]])
sum(ind[[1]])
ind <- list()
ind[[1]] <- dt$Sex == "Female"
ind[[2]] <- dt$`Deprivation index`  == "Quarter 4"
ind[[3]] <- dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above"
ind[[4]] <- dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999"
sum(ind[[1]])
sum(ind[[2]])
sum(ind[[4]])
sum(ind[[5]])
sum(ind[[3]])
ind[[1]]
library(parallel)
mclapply()
fSurv <- function(d){
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = d$data)
return(data.frame(fsim$coefficients, confint(fsim)))
}
fSurv(s1[[1]]$data)
fSurv(s1[[1]])
(s1[[1]])
s1[[1]]$data %>% head
s1[[2]]$data %>% head
fSurv <- function(d){
fsim <- coxph(Surv(y,failed) ~ MVPA_1, data = d)
return(data.frame(fsim$coefficients, confint(fsim)))
}
fSurv <- function(d){
fsim <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
return(data.frame(fsim$coefficients, confint(fsim)))
}
fSurv(s1[[1]]$data)
fSurv(s1[[1]]$data)
fSurv(s1[[1]]$data)
fSurv(s1[[1]]$data)
fSurv(s1[[1]]$data)
?sim.survdata
s <- s1[[1]]
s$data
s[ind[[1]], ]
s <- s1[[1]]$data
s[ind[[1]], ]
fSurv <- function(s, index){
d <- s$data[index, ]
fsim <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
return(data.frame(fsim$coefficients, confint(fsim)))
}
s <- s1[[1]]
fSurv(s, ind[[1]])
fSurv(s, ind[[2]])
fSurv(s, ind[[3]])
fSurv(s, ind[[5]])
fsim <- list()
fSurv <- function(s, index){
fsim <- list()
d <- s$data[index[[1]], ]
fsim[[1]] <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
d <- s$data[index[[2]], ]
fsim[[2]] <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
d <- s$data[index[[3]], ]
fsim[[3]] <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
d <- s$data[index[[4]], ]
fsim[[4]] <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
return(fsim)
}
fSurv(s, ind)
fSurv <- function(s, index){
fsim <- list()
d <- s$data[index[[1]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[1]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[2]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[2]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[3]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[3]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[4]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[4]] <-data.frame(fi$coefficients, confint(fi))
return(fsim)
}
fSurv(s , index)
fSurv(s , ind)
started.at=proc.time()
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 200,
#beta = coefEst,
beta = -0.02
)
cat("Finished in",timetaken(started.at),"\n")
saveRDS(s1, "sim/simDataHR.rds")
started.at=proc.time()
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 200,
#beta = coefEst,
beta = -0.01
)
cat("Finished in",timetaken(started.at),"\n")
saveRDS(s1, "sim/simDataHR001.rds")
#Refresh environment
rm(list= ls())
library(dplyr)
library(survival)
library(data.table)
library(readr)
library(dvmisc)
library(gtsummary)
library(gt)
library(kableExtra)
library(broom.helpers)
library(flextable)
library(officer)
library(ggplot2)
library(coxed)
library(parallel)
dt <- readRDS("./prepped_dt.rds")
dt$MVPA_2 <- dt$MVPA_min_PA2 /20
dt$MVPA_1 <- dt$`MVPA min/week`/ 20
f_cov <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish` + `Type II Diabetes` + `Body Mass Index`"
f_cov_noMediator <- "Sex + Age + Race + `Deprivation index` + Education + `Household Income` + Smoking + Alcohol + `Processed meat` + `Fresh fruit` + `Cooked vegetables` + `Oily fish` + `Non-oily fish`"
f_stroke <-   "Surv(`Follow_up time`,`Myocardial Infarction`)"
f_MI <- "Surv(`Follow_up time`,`Stroke`)"
fitDf1 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_1 + ",  f_cov)), data = dt)
tb1<- tbl_regression(fitDf1, exponentiate = TRUE)
coefEst <- fitDf1$coefficients
fitDf2 <- coxph(as.formula(paste(f_stroke, " ~" ,  "MVPA_2 + ",  f_cov)), data = dt)
tb2<- tbl_regression(fitDf2, exponentiate = TRUE)
ind <- list()
ind[[1]] <- dt$Sex == "Female"
ind[[2]] <- dt$`Deprivation index`  == "Quarter 4"
ind[[3]] <- dt$Education  == "O levels/GCSEs or equivalent, CSEs or equivalent" | dt$Education  == "None of the above"
ind[[4]] <- dt$`Household Income`  == "Less than 18,000" | dt$`Household Income`  == "18,000 to 30,999"
sData <- readRDS("~/projects/UKBB_anaysis/AcclerometerProcessing/sim/simDataHR001_large.rds")
ls()
sData %>% length
fSurv <- function(s, index){
fsim <- list()
d <- s$data[index[[1]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[1]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[2]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[2]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[3]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[3]] <-data.frame(fi$coefficients, confint(fi))
d <- s$data[index[[4]], ]
fi <- coxph(Surv(y,failed) ~ dt.MVPA_1, data = d)
fsim[[4]] <-data.frame(fi$coefficients, confint(fi))
return(fsim)
}
funcGetRange <- function(x, indStrata, lower = TRUE){
if(lower){
lower = x[[indStrata]]["X2.5.."]
}else{
upper = x[[indStrata]]["X97.5.."]
}
}
fits <- mclapply(sData,FUN = fSurv, mc.cores = 10, ind)
fits <- mclapply(sData,FUN = fSurv, mc.cores = 20, ind)
indicatorStrata = 1 # strata
rangeSimEst <- cbind(
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = TRUE) %>% unlist,
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = FALSE) %>% unlist
)
rangeSimEst
rangeSimEst %>% dim()
rangeSimEst[1]
rangeSimEst[,1] %>% hist()
rangeSimEst[,2] %>% hist()
indicatorStrata = 1 # strata
rangeSimEst <- cbind(
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = TRUE) %>% unlist,
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = FALSE) %>% unlist
)
rangeSimEst[,2] %>% hist()
rangeSimEst[, 2] %>% max
rangeSimEst[, 2] %>% min
indicatorStrata = 2 # strata
rangeSimEst <- cbind(
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = TRUE) %>% unlist,
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = FALSE) %>% unlist
)
rangeSimEst[, 2] %>% max
rangeSimEst[, 2] %>% min
indicatorStrata = 3 # strata
rangeSimEst <- cbind(
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = TRUE) %>% unlist,
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = FALSE) %>% unlist
)
rangeSimEst[, 2] %>% max
rangeSimEst[, 2] %>% min
indicatorStrata = 4 # strata
rangeSimEst <- cbind(
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = TRUE) %>% unlist,
lapply(fits, funcGetRange,  indStrata = indicatorStrata, lower = FALSE) %>% unlist
)
rangeSimEst[, 2] %>% max
rangeSimEst[, 2] %>% min
?warnErrList
started.at=proc.time()
s1 <- sim.survdata(
T = 150,
X=data.frame(dt$MVPA_1),
num.data.frames = 200,
#beta = coefEst,
beta = 0.01
)
cat("Finished in",timetaken(started.at),"\n")
saveRDS(s1, "sim/simDataHR_large_002.rds")
