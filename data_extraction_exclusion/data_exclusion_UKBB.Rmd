---
title: "UKBB Data Exclusion"
author: "Yalap"
output: rmarkdown::github_document
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
rm(list=ls())
library(dplyr)
library(readr)
```

We import all data for participants with accelerometer data:

```{r}
# Change the locations to your user folder data files
#full_df <- read.csv("/home/hiroshi/projects/UKBB/Yacine_extract/final_df_full.csv")
full_df <- read.csv("~/projects/UKBB_anaysis/AcclerometerProcessing/final_df_full.csv")
```

# Exclusions: these following commands will only keep the data we are not seeking to exclude

First, we would like to keep count of the number of participants that are excluded
at each step. So we create this function that will allow us to do so:
```{r}
count_exclusions <- function(df_before, df_after) {
  n_before <- nrow(df_before)
  n_after <- nrow(df_after)
  excluded <- n_before - n_after
  print(paste("Participants excluded:", excluded))
  return(list(df = df_after, excluded = excluded))
}

initial_n <- nrow(full_df) # number of participants at the beginning
print(initial_n)
```

## Exclusion 1: Low quality accelerometer data

```{r}
# we want to count how many people were excluded in this section
total_excluded_lq <- 0

# Added by Hiroshi
df_before <- full_df
full_df <- full_df[full_df$accel_raw != "", ]

result <- count_exclusions(df_before, full_df)
total_excluded_lq <- total_excluded_lq + result$excluded
```

### 1.1. Devices poorly calibrated
```{r}
df_before <- full_df
full_df <- full_df[full_df$quality_good_calibration == "Yes", ]
result <- count_exclusions(df_before, full_df)
total_excluded_lq <- total_excluded_lq + result$excluded
```

### 1.2. Participants for whom \>1% of values were clipped (fell outside the 
sensor's range) before or after calibration:
```{r}
df_before <- full_df
full_df <- full_df[(full_df$clips_before_cal < 0.01 * full_df$total_reads) & (full_df$clips_after_cal < 0.01 * full_df$total_reads), ]
result <- count_exclusions(df_before, full_df)
total_excluded_lq <- total_excluded_lq + result$excluded
```

### 1.3 Insufficient wear time
```{r}
df_before <- full_df
full_df <- full_df[full_df$quality_good_wear_time == "Yes", ]# OxWearable note: Note that this has already been calculated in UKB, we don't need to manually calculate it: https://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=90015
result <- count_exclusions(df_before, full_df)
total_excluded_lq <- total_excluded_lq + result$excluded
```

### 1.4 Unrealistically high acceleration values
```{r}
df_before <- full_df
full_df <- full_df[full_df$overall_activity < 100, ]
result <- count_exclusions(df_before, full_df)
total_excluded_lq <- total_excluded_lq + result$excluded
```

```{r}
print(paste("Total participants excluded due to not being in acceleromete subcohort or low accelerometer data quality:", total_excluded_lq))
```


## Exclusion 2: Reported CVD

```{r}
# we extract the CVD date columns
date_columns <- c(
  'stroke_date', 'ischaemic_stroke_date', 'intracerebral_haemorrhage_date',
  'myocardial_infarction_date', 'STEMI_date', 'NSTEMI_date'
)

# we format the date columns
for (col in date_columns) {
  full_df[[col]] <- as.Date(full_df[[col]], format="%Y-%m-%d")
}

# cut-off date = 2013-01-01 because we do not want to keep participants that reported
# having a CVD < 2013
cut_off_date <- "2013-01-01"

# create loop to count number of participants excluded for each CVD
total_excluded_cvd <- 0
for (col in date_columns) {
  result <- count_and_filter_dates(full_df, col, cut_off_date)
  full_df <- result$df
  exclusions[[paste("Excluded based on", col)]] <- result$excluded_count
  total_excluded_cvd <- total_excluded_cvd + result$excluded_count
}

# Print total exclusions for step 2
print(paste("Total participants excluded because of CVD:", total_excluded_cvd))
```

## Exclusion 3: Missing covariate data

We remove rows for participants that have missing data for ethnicity, education, sex, birth date, smoking status, alcohol consumption, Townsend Deprivation Index; oily fish, fresh fruit, cooked veggies or processed meat consumption, and BMI.

```{r}
df_before <- full_df
keep_cols <- c('smoking_raw', 'alcohol_raw', 'ethnicity_raw', 'tdi_raw', 'education_raw', 'oily_fish', 'fresh_fruit', 'cooked_vg', 'BMI_raw', 'sex', 'month_birth', 'year_birth')
full_df <- full_df[complete.cases(full_df[, keep_cols]), ]
result <- count_exclusions(df_before, full_df)
total_excluded_covd <- result$excluded

# Print total exclusions for step 3
print(paste("Total participants excluded in step 3:", total_excluded_covd))
```


## Final count

```{r}
final_n <- nrow(full_df)
print(paste("After applying all exclusions, we end up with a sample of n =", final_n," participants"))
```




