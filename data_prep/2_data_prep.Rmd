---
title: "2_data_prep"
author: "yacine"
date: "2024-08-08"
output: html_document
---

output:
  pdf_document: default
  html_document: default
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


#Refresh environment 
rm(list= ls())
library(dplyr)
library(survival)
library(data.table)
library(readr)
library(dvmisc)
library(gtsummary)
library(gt)
library(kableExtra)
library(broom.helpers)
library(flextable)
library(officer)
library(ggplot2)

theme_gtsummary_journal("jama")
```


## We load the data:
```{r}
#full_df <- read.csv("/home/yacine/final_df_full.csv") # full df w/o exclusions
#full_df <- read.csv("/home/yacine/UKBB_beluga/df_exc.csv") # full df with exclusions
full_df <- read.csv("/home/yacine/UKBB_beluga/df_exc_recode.csv") # full df with exclusions + recoding
```



## CVD 
We change the date format for the start and end accelerometer variables - which
will be crucial for later steps:
```{r}
full_df$date_start_accel <- as.Date(full_df$date_start_accel)
full_df$date_end_accel <- as.Date(full_df$date_end_accel)
```


First we create the "end_of_fu" variable, which can be classified as date of 
stroke/MI, date of death or the end of the study (i.e. 2022):

```{r}
# we find out which death date is the latest which we will set as the "end of the study" 
# date
max_death_date_0 <- max(full_df$'date_of_death_0', na.rm = TRUE)
max_death_date_1 <- max(full_df$'date_of_death_1', na.rm = TRUE)
print(max_death_date_0)
print(max_death_date_1)

# given that we see that the max(death_date) is "2022-12-17", this will serve as 
# our "end of study" date

# we create a "end_of_study" column which indicates the end of the whole data collection:
full_df$end_of_study_date <- as.Date('2022-12-17')

# we reate a vector of all the date columns:
date_cols <- c('stroke_date', 'ischaemic_stroke_date', 'intracerebral_haemorrhage_date',
               'myocardial_infarction_date', 'STEMI_date', 'NSTEMI_date',
               'date_of_death_0', 'date_of_death_1', 'date_lost_followup',
               'end_of_study_date')



# we make sure all values within the date columns are in date format:
full_df[date_cols] <- lapply(full_df[date_cols], as.Date)

# we create the end_of_fu column by only keeping the earliest date from each rows
# within each date columns:
full_df$end_of_fu <- apply(full_df[date_cols], 1, function(x) min(x[!is.na(x)]))

#print(full_df$end_of_fu)
```

### Follow-up time 
We can now create the "follow-up time" column by calculating the difference (in months) 
between the "end of follow up" and "end time of wear" columns:
```{r}
# remove NA data from date_end_accel (to do in data exclusion UKBB script?)
full_df <- full_df[!is.na(full_df$date_end_accel), ]

difftime_weeks <- difftime(full_df$end_of_fu, full_df$date_end_accel, units = "weeks")

# because the "difftime" function only allows a maximum of units in weeks, we 
# devide by 4.345 to convert to difference months
full_df$fu_time <- as.numeric(difftime_weeks) / 4.345

head(full_df$fu_time) 
#print(full_df$date_start_accel)

hist(full_df$fu_time, main = "survival time in Month")



```

Follow-up time for PA4:
```{r}
# remove NA data from date_end_accel (to do in data exclusion UKBB script?)
full_df <- full_df[!is.na(full_df$end_of_fu), ]

difftime_weeks <- difftime(full_df$end_of_fu, full_df$assessment_visit_0, units = "weeks")

# because the "difftime" function only allows a maximum of units in weeks, we 
# devide by 4.345 to convert to difference months
full_df$fu_time_pa4 <- as.numeric(difftime_weeks) / 4.345

head(full_df$fu_time_pa4) 
#print(full_df$date_start_accel)

hist(full_df$fu_time_pa4, main = "survival time in Month")




```



### CVD indicator (strokes and MI)

```{r}
# First we create a new column which will indicate if a participant has had: 
## a) a stroke == 1; or not == 0:
stroke_cols <- c('stroke_date', 'ischaemic_stroke_date', 'intracerebral_haemorrhage_date')

# Create the 'stroke' column
full_df$stroke <- ifelse(rowSums(!is.na(full_df[, stroke_cols ])) > 0, 1, 0)


## b) a MI == 1; or not == 0:
MI_cols <- c('myocardial_infarction_date', 'STEMI_date', 'NSTEMI_date')
full_df$MI <- ifelse(rowSums(!is.na(full_df[, MI_cols ])) > 0, 1, 0)


head(full_df$stroke)
head(full_df$MI)

# We now create a composit "CVD" column which indicates if the participants has had a
# stroke and/or MI (==1) or not (==0)
full_df <- full_df %>%
  mutate(CVD = ifelse(stroke == 1 | MI == 1, 1, 0))
```


## 2 years of survival:
We create two new columns ('2_years_survival_stroke' and '2_years_survival_MI')
which will indicate if the participant has had either disease in the next two years
following the end of the accelerometer tracking. Therefore, the value for the two
new columns will be 0 if the person has had the disease within the 2 following years; 
1 if they had the disease more than 2 years after, or if they simply never had the disease. 
These columns will be used for sensitivity analysis 4.

### 2 years of survival - Stroke:

```{r}

full_df <- full_df %>%
  mutate(date_end_accel = as.Date(date_end_accel),
         stroke_date = as.Date(stroke_date)) %>%
  
  mutate('2_years_survival_stroke' = case_when(
    is.na(stroke_date) ~ 1,   # never had stroke == 0
    !is.na(stroke_date) & !is.na(date_end_accel) &
      as.numeric(difftime(stroke_date, date_end_accel, units = 'days')) > (2*365) ~ 1, # date_end_accel - stroke_date > 2                                                                                                                        == 1
    !is.na(stroke_date) & !is.na(date_end_accel) ~ 0, # date_end_accel - stroke_date < 2 == 0
    TRUE ~ NA  
  ))

table(full_df$'2_years_survival_stroke')
```

### 2 years of survival - MI:

```{r}

full_df <- full_df %>%
  mutate(date_end_accel = as.Date(date_end_accel),
         myocardial_infarction_date = as.Date(myocardial_infarction_date)) %>%
  
  mutate('2_years_survival_MI' = case_when(
    is.na(myocardial_infarction_date) ~ 1,  # never had MI == 1
    !is.na(myocardial_infarction_date) & !is.na(date_end_accel) &
      as.numeric(difftime(myocardial_infarction_date, date_end_accel, units = 'days')) > (2*365) ~ 1, # date_end_accel - MI_date > 2 == 1
    !is.na(myocardial_infarction_date) & !is.na(date_end_accel) ~ 0, # date_end_accel - MI_date < 2 == 0
    TRUE ~ NA  
  ))


table(full_df$'2_years_survival_MI')

```

######################### Hiroshi comment - January 2025 ##################
Original:
SB: less than or equal to 50
LPA: [50,100]
MVPA: >=125
MVPA2:  >=100
MVPA3: >=150
VPA: >=400
 
 
New thresholds only for MVPA in the data shared with Yacine for PA1 (yesterday):
SB: less than or equal to 50
LPA: [50,100]
MVPA: >=100
MVPA2: >=150
MVPA3: >=200
VPA: >=400

##########################

## PA 
### Now link data with acclerometer weekly minutes, for LPA, MVPA, and sedendary behavior.   
- There are 4 different accelerometric measures   
  1. PA1 - Vector magnitude based measures as calcuated from time-series of vector magnitude by UKBB 
  2. PA2 - machine-learning derived mesared, for Field ID 1020
  3. PA3 - Activity Count count-based measure, based on Freedson cutoff 
  4. PA4 - Self reported PA data

### PA1 Files from parallel processing of time-series (FieldID 90004) to generate ENMO summary of 100,000 ppl, PA1 data 
```{r, include=FALSE, message=FALSE}
enmoTSParallel_PA1 <- list.files(path="/home/yacine/survival_analysis/PA1_parallel_TS_ENMO/outputs", full.names = TRUE) %>% 
  lapply(read_csv) %>% 
  bind_rows 

enmoTSParallel_PA1$MVPA_min <- enmoTSParallel_PA1$MVPA_total* 7*24*60
enmoTSParallel_PA1$LPA_min <- enmoTSParallel_PA1$LPA_total* 7*24*60
enmoTSParallel_PA1$SB_min <- enmoTSParallel_PA1$SB_total* 7*24*60

colnames(enmoTSParallel_PA1) <- paste(colnames(enmoTSParallel_PA1), "_PA1", sep = "")

colnames(enmoTSParallel_PA1)[1] <- "eid"

### Added PA1 - January 2025
enmoTSParallel_PA1_v2 <- read_csv("/home/aayush/PA1_3_new_thresholds/outputs/PA1_combined_df.csv", col_select = -1)
enmoTSParallel_PA1_v2$MVPA_100 <- enmoTSParallel_PA1_v2$MVPA2_total* 7*24*60
enmoTSParallel_PA1_v2$MVPA_150 <- enmoTSParallel_PA1_v2$MVPA3_total* 7*24*60


colnames(enmoTSParallel_PA1_v2)[1] <- "eid"

```


### PA2 Load derived accelerometer from UKBB, PA2 data 
```{r, include=FALSE}
ML_derived_PA2 <- fread("/home/yacine/survival_analysis/PA2_category_1020.csv")
ML_derived_PA2 <- ML_derived_PA2 %>%  dplyr::select(
  eid, 
  "40048-0.0",  
  "40049-0.0",
  "40047-0.0", 
  "40046-0.0", 
  "40044-0.0",  
  "40045-0.0",
  "40043-0.0", 
  "40042-0.0" 
)

# relabel for id, weekly light PA, weekly MVPA, weekly sleep, weekly sedentary, daily light PA, daily MVPA, daily sedentary
names(ML_derived_PA2) <- c("eid", "overall_l", "overall_mv", "overall_sb", "overall_slp", "day_l", "day_mv", "day_sb", "day_slp")

ML_derived_PA2 <- ML_derived_PA2 %>% filter(!is.na(overall_l))

dim(ML_derived_PA2)


ML_derived_PA2$MVPA_min <- ML_derived_PA2$overall_mv * 7 * 24 * 60 



ML_derived_PA2$MVPA_min <- ML_derived_PA2$overall_mv* 7*24*60
ML_derived_PA2$LPA_min <- ML_derived_PA2$overall_l* 7*24*60
ML_derived_PA2$SB_min <- ML_derived_PA2$overall_sb* 7*24*60

colnames(ML_derived_PA2) <- paste(colnames(ML_derived_PA2), "_PA2", sep = "")
colnames(ML_derived_PA2)[1] <- "eid"


```






### PA3 - we load PA3
```{r}
PA3_proportions_data <- read_csv("/home/yacine/UKBB_beluga/PA3_df/PA3_data.csv",col_select = -1)

PA3_proportions_data <- PA3_proportions_data %>%
  rename(
    eid = participant_id,
    PA3_light = light,
    PA3_MVPA = `moderate-vigorous`,
    PA3_sedentary = sedentary 
  )

PA3_proportions_data$MVPA_min <- PA3_proportions_data$PA3_MVPA * 7 * 24 * 60 



PA3_proportions_data$MVPA_min <- PA3_proportions_data$PA3_MVPA* 7*24*60
PA3_proportions_data$LPA_min <- PA3_proportions_data$PA3_light* 7*24*60
PA3_proportions_data$SB_min <- PA3_proportions_data$PA3_sedentary* 7*24*60

colnames(PA3_proportions_data) <- paste(colnames(PA3_proportions_data), "_PA3", sep = "")
colnames(PA3_proportions_data)[1] <- "eid"

PA3_proportions_data <- na.omit(PA3_proportions_data)



# PA3 added January 2025
PA3_proportions_data_v2 <- read_csv("/home/aayush/PA1_3_new_thresholds/outputs/PA3_L2_one_minute_without_duplicates.csv",col_select = -1)

PA3_proportions_data_v2 <- PA3_proportions_data_v2 %>%
  rename(
    eid = participant_id,
    PA3_light = light,
    PA3_MVPA = `moderate-vigorous`,
    PA3_sedentary = sedentary 
  )

PA3_proportions_data_v2$MVPA_min <- PA3_proportions_data_v2$PA3_MVPA * 7 * 24 * 60 



PA3_proportions_data_v2$MVPA_min <- PA3_proportions_data_v2$PA3_MVPA* 7*24*60
PA3_proportions_data_v2$LPA_min <- PA3_proportions_data_v2$PA3_light* 7*24*60
PA3_proportions_data_v2$SB_min <- PA3_proportions_data_v2$PA3_sedentary* 7*24*60

colnames(PA3_proportions_data_v2) <- paste(colnames(PA3_proportions_data_v2), "_PA3_v2", sep = "")
colnames(PA3_proportions_data_v2)[1] <- "eid"

PA3_proportions_data_v2 <- na.omit(PA3_proportions_data_v2)



```


### Merge the full_df and PA1 and PA2 df by eids
```{r}
full_df_PA <- inner_join(
  full_df, 
  enmoTSParallel_PA1 %>% 
    dplyr::select(eid, MVPA_min_PA1, LPA_min_PA1, SB_min_PA1),
  by = "eid")

# PA1 data added in January 2025
full_df_PA <- inner_join(
  full_df_PA, 
  enmoTSParallel_PA1_v2 %>% 
    dplyr::select(eid, MVPA_100, MVPA_150),
  by = "eid"
)


full_df_PA<- inner_join(full_df_PA, 
  ML_derived_PA2 %>% 
    dplyr::select(eid, MVPA_min_PA2, LPA_min_PA2, SB_min_PA2),
  by = "eid")


```


### Merge PA3
```{r}
full_df_PA<- inner_join(full_df_PA, 
  PA3_proportions_data %>% 
    dplyr::select(eid, MVPA_min_PA3, LPA_min_PA3, SB_min_PA3),
  by = "eid")


# PA3 data added January 2025
full_df_PA<- inner_join(full_df_PA, 
  PA3_proportions_data_v2 %>% 
    dplyr::select(eid, MVPA_min_PA3_v2, LPA_min_PA3_v2, SB_min_PA3_v2),
  by = "eid")

```

### Create quantile pA group and remove outliers
```{r}
sum(full_df_PA$MVPA_min_PA1 > 2100 )
summary(full_df_PA$MVPA_min_PA1)

sum(full_df_PA$MVPA_min_PA2 > 2100 )
summary(full_df_PA$MVPA_min_PA2)

#sum(full_df_PA$MVPA_min_PA3 > 2500 )
#summary(full_df_PA$MVPA_min_PA3)

# we create a new table to include PA4
full_df_PA_2 <- full_df_PA
sum(full_df_PA_2$MVPA_min_PA4 > 2100)
summary(full_df_PA_2$MVPA_min_PA4)


dim(full_df_PA)
full_df_PA <- full_df_PA %>%  filter(MVPA_min_PA2 < 2500)
full_df_PA <- full_df_PA %>%  filter(MVPA_min_PA1 < 2500)
full_df_PA <- full_df_PA %>%  filter(MVPA_min_PA3 < 2500)
dim(full_df_PA)

# full_df_PA_2
full_df_PA_2 <- full_df_PA_2 %>%  filter(MVPA_min_PA2 < 2500)
full_df_PA_2 <- full_df_PA_2 %>%  filter(MVPA_min_PA1 < 2500)
full_df_PA_2 <- full_df_PA_2 %>%  filter(MVPA_min_PA3 < 2500)
full_df_PA_2 <- full_df_PA_2 %>%  filter(MVPA_min_PA4 < 2100)
dim(full_df_PA_2)


##### might want to remove that part
full_df_PA$MVPA_Quant_PA1 <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA1, 4) %>% factor()
full_df_PA$MVPA_Quant_PA2 <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA2, 4) %>% factor()
full_df_PA$MVPA_Quant_PA3 <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA3, 4) %>% factor()

# full_df_PA_2
full_df_PA_2$MVPA_Quant_PA1 <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA1, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA2 <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA2, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA3 <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA3, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA4 <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA4, 4) %>% factor()


dfPA1Label <- data.frame(range = full_df_PA$MVPA_Quant_PA1 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2Label <- data.frame(range = full_df_PA$MVPA_Quant_PA2 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA3Label <- data.frame(range = full_df_PA$MVPA_Quant_PA3 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))

# full_df_PA_2
dfPA1Label <- data.frame(range = full_df_PA_2$MVPA_Quant_PA1 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2Label <- data.frame(range = full_df_PA_2$MVPA_Quant_PA2 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2Label <- data.frame(range = full_df_PA_2$MVPA_Quant_PA3 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA4Label <- data.frame(range = full_df_PA_2$MVPA_Quant_PA4 %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))

```



### Plot MVPA 

#### PA1 (ENMO) and PA2 (ML)
```{r}
# check plot to see if there are extreme data points or not 
boxplot(MVPA_min_PA1 ~ MVPA_Quant_PA1, data = full_df_PA, main = "Categorical MVPA CV Numeric MVPA")
boxplot(MVPA_min_PA2 ~ MVPA_Quant_PA2, data = full_df_PA, main = "Categorical MVPA CV Numeric MVPA")



# And scatter plot 
library(ggExtra)
library(BlandAltmanLeh)
print(ggExtra::ggMarginal(
  bland.altman.plot(
    full_df_PA$MVPA_min_PA1, 
    full_df_PA$MVPA_min_PA2, 
    graph.sys = "ggplot2"
    ),
  theme_minimal(),
  type = "histogram", size=4)
)



ggplot(full_df_PA, 
       aes(x=full_df_PA$MVPA_min_PA1, 
           y=full_df_PA$MVPA_min_PA2)) + 
  geom_point(color="black", size = 0.3) +
  theme_classic() + 
  xlab("MVPA minutes / week - Vector Magnitude (ENMO)") + 
  ylab("MVPA minutes / week - ML") +  
  geom_smooth(method=lm, 
    se=FALSE, 
    linetype="dashed",
    color="grey",
  ) +
  ggtitle("Accelerometer Data and ML")



```

##### PA3 (Activity Count) and PA2 (ML)
```{r}
# check plot to see if there are extreme data points or not 
boxplot(MVPA_min_PA3 ~ MVPA_Quant_PA3, data = full_df_PA, main = "Categorical MVPA CV Numeric MVPA")
boxplot(MVPA_min_PA2 ~ MVPA_Quant_PA2, data = full_df_PA, main = "Categorical MVPA CV Numeric MVPA")



# And scatter plot 
library(ggExtra)
library(BlandAltmanLeh)
print(ggExtra::ggMarginal(
  bland.altman.plot(
    full_df_PA$MVPA_min_PA3, 
    full_df_PA$MVPA_min_PA2, 
    graph.sys = "ggplot2"
    ),
  theme_minimal(),
  type = "histogram", size=4)
)



ggplot(full_df_PA, 
       aes(x=full_df_PA$MVPA_min_PA3, 
           y=full_df_PA$MVPA_min_PA2)) + 
  geom_point(color="black", size = 0.3) +
  theme_classic() + 
  xlab("MVPA minutes / week - Activity Count") + 
  ylab("MVPA minutes / week - ML") +  
  geom_smooth(method=lm, 
    se=FALSE, 
    linetype="dashed",
    color="grey",
  ) +
  ggtitle("Activity Count and ML")


```



#### PA4 (self-reported) and PA2 (ML)
```{r}
# check plot to see if there are extreme data points or not 
boxplot(MVPA_min_PA4 ~ MVPA_Quant_PA4, data = full_df_PA_2, main = "Categorical MVPA CV Numeric MVPA")
boxplot(MVPA_min_PA2 ~ MVPA_Quant_PA2, data = full_df_PA_2, main = "Categorical MVPA CV Numeric MVPA")




# And scatter plot 
library(ggExtra)
library(BlandAltmanLeh)
print(ggExtra::ggMarginal(
  bland.altman.plot(
    full_df_PA_2$MVPA_min_PA4, 
    full_df_PA_2$MVPA_min_PA2, 
    graph.sys = "ggplot2"
    ),
  theme_minimal(),
  type = "histogram", size=4),
)




ggplot(full_df_PA_2, 
       aes(x=full_df_PA_2$MVPA_min_PA4, 
           y=full_df_PA_2$MVPA_min_PA2)) + 
  geom_point(color="black", size = 0.3) +
  theme_classic() + 
  xlab("MVPA minutes / week - Self-Report (IPAQ)") + 
  ylab("MVPA minutes / week - ML") +  
  geom_smooth(method=lm, 
    se=FALSE, 
    linetype="dashed",
    color="grey",
    main = "Self-Report (IPAQ) and Machine Learning"
  ) +
  ggtitle("Self-Report (IPAQ) and Machine Learning")


# get the slope 
reg <- lm(MVPA_min_PA2 ~ MVPA_min_PA4, data = full_df_PA_2)
coefficients <- coef(reg)
slope <- coefficients["MVPA_min_PA4"]
print(slope)


```


### Excess duration - Flag people with too high values of MVPA and make new category removing them 
```{r}
full_df_PA <- full_df_PA %>%  
  mutate( MVPA_min_PA1_truncated = ifelse(MVPA_min_PA1 > 1250, NA, MVPA_min_PA1), 
          MVPA_min_PA2_truncated = ifelse(MVPA_min_PA2 > 1250, NA, MVPA_min_PA2),
          MVPA_min_PA3_truncated = ifelse(MVPA_min_PA3 > 1250, NA, MVPA_min_PA3)
          ) 


full_df_PA$MVPA_Quant_PA1_truncated <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA1_truncated, 4) %>% factor()
full_df_PA$MVPA_Quant_PA2_truncated <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA2_truncated, 4) %>% factor()
full_df_PA$MVPA_Quant_PA3_truncated <- dvmisc::quant_groups(full_df_PA$MVPA_min_PA3_truncated, 4) %>% factor()

dfPA1LabelTrunc <- data.frame(range = full_df_PA$MVPA_Quant_PA1_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2LabelTrunc <- data.frame(range = full_df_PA$MVPA_Quant_PA2_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA3LabelTrunc <- data.frame(range = full_df_PA$MVPA_Quant_PA3_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
```
### Same as previous step but with PA4 included (full_df_PA_2 df)
```{r}
full_df_PA_2 <- full_df_PA_2 %>%  
  mutate( MVPA_min_PA1_truncated = ifelse(MVPA_min_PA1 > 1250, NA, MVPA_min_PA1), 
          MVPA_min_PA2_truncated = ifelse(MVPA_min_PA2 > 1250, NA, MVPA_min_PA2),
          MVPA_min_PA3_truncated = ifelse(MVPA_min_PA3 > 1250, NA, MVPA_min_PA3),
          MVPA_min_PA4_truncated = ifelse(MVPA_min_PA4 > 1000, NA, MVPA_min_PA4)
          ) 


full_df_PA_2$MVPA_Quant_PA1_truncated <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA1_truncated, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA2_truncated <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA2_truncated, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA3_truncated <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA3_truncated, 4) %>% factor()
full_df_PA_2$MVPA_Quant_PA4_truncated <- dvmisc::quant_groups(full_df_PA_2$MVPA_min_PA4_truncated, 4) %>% factor()


dfPA1LabelTrunc <- data.frame(range = full_df_PA_2$MVPA_Quant_PA1_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2LabelTrunc <- data.frame(range = full_df_PA_2$MVPA_Quant_PA2_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA2LabelTrunc <- data.frame(range = full_df_PA_2$MVPA_Quant_PA3_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
dfPA4LabelTrunc <- data.frame(range = full_df_PA_2$MVPA_Quant_PA4_truncated %>% levels(), Q = c("Q1", "Q2", "Q3", "Q4"))
```


## Covariates - reorder 
```{r}
# Re-order categories 
full_df_PA$cooked_vg %>% table
full_df_PA$cooked_vg <- factor(full_df_PA$cooked_vg)
levels(full_df_PA$cooked_vg)
levels(full_df_PA$cooked_vg) <- list( 'Less than 2 servings a day' ="< 2 servings/day", 'Between 2 and 4 servings a day' = "2 to 4 servings/day", 'More than 4 servings a day' =  "More than 4 servings/day") 
full_df_PA$cooked_vg %>% table


full_df_PA$fresh_fruit %>% table
full_df_PA$fresh_fruit <- factor(full_df_PA$fresh_fruit)
levels(full_df_PA$fresh_fruit)
levels(full_df_PA$fresh_fruit) <- list( 'Less than 2 servings a day' ="< 2 servings/day", 'Between 2 and 4 servings a day' = "2 to 4 servings/day", 'More than 4 servings a day' =  "More than 4 servings/day") 
full_df_PA$fresh_fruit %>% table


full_df_PA$smoking %>% table 
full_df_PA$smoking<- factor(full_df_PA$smoking)
levels(full_df_PA$smoking)
levels(full_df_PA$smoking) <- list( 'Never' = "Never", 
                                    'Previously' = "Previous", 
                                    'Currently' =  "Current") 


full_df_PA$BMI %>% table 
full_df_PA$BMI <- factor(full_df_PA$BMI)
levels(full_df_PA$BMI)
levels(full_df_PA$BMI) <- list( "Underweight (< 18.5 kg/m2)" = "Underweight (< 18.5 kg/m2)",
                                "Normal (18.5 kg/m2 to < 25 kg/m2)" = "Normal (18.5 kg/m2 to < 25 kg/m2)" ,
                                "Overweight (25 kg/m2 to < 30 kg/m2)" = "Overweight (25 kg/m2 to < 30 kg/m2)",
                                "Obesity Class I, II or III (> 30 kg/m2)" = "Obesity Class I, II or III (> 30 kg/m2)") 

full_df_PA$alcohol %>% table 
full_df_PA$alcohol <- factor(full_df_PA$alcohol)
levels(full_df_PA$alcohol)
levels(full_df_PA$alcohol) <- list( "Never" = "Never", 
                                    "Less than once a week" = "Less than once a week", 
                                    "Once or twice a week" =  "Once or twice a week",
                                    "Three or four times a week" = "Three or four times a week",
                                    "Daily or almost daily" = "Daily or almost daily") 


full_df_PA$avg_hh_income %>% table 
full_df_PA$avg_hh_income <- factor(full_df_PA$avg_hh_income)
levels(full_df_PA$avg_hh_income)
levels(full_df_PA$avg_hh_income) <- list( "Less than 18,000" = "Less than 18,000",
                                          "18,000 to 30,999" = "18,000 to 30,999",
                                          "31,000 to 51,999" = "31,000 to 51,999",
                                          "52,000 to 100,000" = "52,000 to 100,000",
                                          "Greater than 100,000" = "Greater than 100,000",
                                          "Do not know/Prefer not to answer" = "Do not know/Prefer not to answer") 


full_df_PA$processed_meat %>% table 
full_df_PA$processed_meat <- factor(full_df_PA$processed_meat)
levels(full_df_PA$processed_meat)
levels(full_df_PA$processed_meat) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA$oily_fish %>% table 
full_df_PA$oily_fish <- factor(full_df_PA$oily_fish)
levels(full_df_PA$oily_fish)
levels(full_df_PA$oily_fish) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA$non_oily_fish %>% table 
full_df_PA$non_oily_fish <- factor(full_df_PA$non_oily_fish)
levels(full_df_PA$non_oily_fish)
levels(full_df_PA$non_oily_fish) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA$red_meat %>% table 
full_df_PA$red_meat <- factor(full_df_PA$red_meat)
levels(full_df_PA$red_meat)
levels(full_df_PA$red_meat) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA$education_level %>% table 
full_df_PA$education_level <- factor(full_df_PA$education_level)
levels(full_df_PA$education_level)
levels(full_df_PA$education_level) <- list( "None of the below" = "None of the above", 
                                    "O levels/GCSEs or equivalent, CSEs or equivalent" =  "O levels/GCSEs or equivalent, CSEs or equivalent",
                                    "A levels/AS, NVQ/HND/HNC or equivalent" = "A levels/AS levels or equivalent, NVQ or HND or HNC or equivalent, other professional qualifications",
                                    "College or University degree" = "College or University degree") 

```


### Covariates - reorder for full_df_PA_2 df
```{r}
# Re-order categories 
full_df_PA_2$cooked_vg %>% table
full_df_PA_2$cooked_vg <- factor(full_df_PA_2$cooked_vg)
levels(full_df_PA_2$cooked_vg)
levels(full_df_PA_2$cooked_vg) <- list( 'Less than 2 servings a day' ="< 2 servings/day", 'Between 2 and 4 servings a day' = "2 to 4 servings/day", 'More than 4 servings a day' =  "More than 4 servings/day") 
full_df_PA_2$cooked_vg %>% table


full_df_PA_2$fresh_fruit %>% table
full_df_PA_2$fresh_fruit <- factor(full_df_PA_2$fresh_fruit)
levels(full_df_PA_2$fresh_fruit)
levels(full_df_PA_2$fresh_fruit) <- list( 'Less than 2 servings a day' ="< 2 servings/day", 'Between 2 and 4 servings a day' = "2 to 4 servings/day", 'More than 4 servings a day' =  "More than 4 servings/day") 
full_df_PA_2$fresh_fruit %>% table


full_df_PA_2$smoking %>% table 
full_df_PA_2$smoking<- factor(full_df_PA_2$smoking)
levels(full_df_PA_2$smoking)
levels(full_df_PA_2$smoking) <- list( 'Never' = "Never", 
                                    'Previously' = "Previous", 
                                    'Currently' =  "Current") 


full_df_PA_2$BMI %>% table 
full_df_PA_2$BMI <- factor(full_df_PA_2$BMI)
levels(full_df_PA_2$BMI)
levels(full_df_PA_2$BMI) <- list( "Underweight (< 18.5 kg/m2)" = "Underweight (< 18.5 kg/m2)",
                                "Normal (18.5 kg/m2 to < 25 kg/m2)" = "Normal (18.5 kg/m2 to < 25 kg/m2)" ,
                                "Overweight (25 kg/m2 to < 30 kg/m2)" = "Overweight (25 kg/m2 to < 30 kg/m2)",
                                "Obesity Class I, II or III (> 30 kg/m2)" = "Obesity Class I, II or III (> 30 kg/m2)") 

full_df_PA_2$alcohol %>% table 
full_df_PA_2$alcohol <- factor(full_df_PA_2$alcohol)
levels(full_df_PA_2$alcohol)
levels(full_df_PA_2$alcohol) <- list( "Never" = "Never", 
                                    "Less than once a week" = "Less than once a week", 
                                    "Once or twice a week" =  "Once or twice a week",
                                    "Three or four times a week" = "Three or four times a week",
                                    "Daily or almost daily" = "Daily or almost daily") 


full_df_PA_2$avg_hh_income %>% table 
full_df_PA_2$avg_hh_income <- factor(full_df_PA_2$avg_hh_income)
levels(full_df_PA_2$avg_hh_income)
levels(full_df_PA_2$avg_hh_income) <- list( "Less than 18,000" = "Less than 18,000",
                                          "18,000 to 30,999" = "18,000 to 30,999",
                                          "31,000 to 51,999" = "31,000 to 51,999",
                                          "52,000 to 100,000" = "52,000 to 100,000",
                                          "Greater than 100,000" = "Greater than 100,000",
                                          "Do not know/Prefer not to answer" = "Do not know/Prefer not to answer") 


full_df_PA_2$processed_meat %>% table 
full_df_PA_2$processed_meat <- factor(full_df_PA_2$processed_meat)
levels(full_df_PA_2$processed_meat)
levels(full_df_PA_2$processed_meat) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA_2$oily_fish %>% table 
full_df_PA_2$oily_fish <- factor(full_df_PA_2$oily_fish)
levels(full_df_PA_2$oily_fish)
levels(full_df_PA_2$oily_fish) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA_2$non_oily_fish %>% table 
full_df_PA_2$non_oily_fish <- factor(full_df_PA_2$non_oily_fish)
levels(full_df_PA_2$non_oily_fish)
levels(full_df_PA_2$non_oily_fish) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA_2$red_meat %>% table 
full_df_PA_2$red_meat <- factor(full_df_PA_2$red_meat)
levels(full_df_PA_2$red_meat)
levels(full_df_PA_2$red_meat) <- list( "Less than 2 times a week" = "Less than 2 times a week", 
                                    "2-4 times a week" = "2-4 times a week", 
                                    "More than 4 times a week" =  "More than 4 times a week") 

full_df_PA_2$education_level %>% table 
full_df_PA_2$education_level <- factor(full_df_PA_2$education_level)
levels(full_df_PA_2$education_level)
levels(full_df_PA_2$education_level) <- list( "None of the above" = "None of the above", 
                                    "O levels/GCSEs or equivalent, CSEs or equivalent" =  "O levels/GCSEs or equivalent, CSEs or equivalent",
                                    "A levels/AS, NVQ/HND/HNC or equivalent" = "A levels/AS levels or equivalent, NVQ or HND or HNC or equivalent, other professional qualifications",
                                    "College or University degree" = "College or University degree") 

```


# Tables 

## Table 1.1 - PA1, PA2 & PA3
```{r}
# Variables to add to the table - this variable cannot be used to select colum,ns now, since cooked_veg is not rendred into summary table 

dt <- full_df_PA %>%  dplyr::select(
  fu_time, 
  `2_years_survival_stroke`,
  `2_years_survival_MI`,
  MVPA_Quant_PA1,
  MVPA_Quant_PA2,  
  MVPA_Quant_PA3,
  #MVPA_Quant_PA4,  
  MVPA_min_PA1,
  MVPA_100,
  MVPA_150,
  MVPA_min_PA2,
  MVPA_min_PA3,
 # MVPA_min_PA4, 
  MI, 
  stroke,
  age_entry_years, 
  ethnicity, 
  sex, 
  education_level,
  avg_hh_income,
  tdi,
  avg_hh_income,
  #BMI,
  #diabetes,
  #depression,
  smoking, 
  alcohol, 
  processed_meat, 
  red_meat,
  oily_fish,
  non_oily_fish,
  fresh_fruit,
  cooked_vg,
  #water_300m,
  #greenspace_300m,
  #naturalenv_300m,
  MVPA_Quant_PA1_truncated, 
  MVPA_Quant_PA2_truncated,
  MVPA_Quant_PA3_truncated,
  #MVPA_Quant_PA4_truncated,
  MVPA_min_PA1_truncated, 
  MVPA_min_PA2_truncated,
  MVPA_min_PA3_truncated,
  #MVPA_min_PA4_truncated
 cancer, 
 syst_bp,
 diast_bp,
 hdl_chol, glucose_blood_biochem, 
 overall_health_rating, triglycerides_0,
 c_reactive_protein_0
  ) 

# Convert variable names into desruptive table names 
varNameDf <- data.frame(
  varName = c("Myocardial infarction",
              "Stroke",
              "Age",
              "MVPA min/week - ENMO",
              "MVPA min/week - Machine learning",
              "MVPA min/week - Activity count",
              "Race", 
              "Deprivation index", 
              "Education", 
              "Household income GBP",
              "Smoking", 
              "Alcohol consumption", 
              "Processed meat",
              "Red meat",
              "Fresh fruit", 
              "Cooked vegetables", 
              "Oily fish", 
              "Non-oily fish",
              "Sex", 
              "Follow up time in months",
              "Cancer",
              "Systolic blood pressure",
              "Diastolic blood pressure",
              "HDL cholesterol",
              "Blood glucose (biochemistry)",
              "Overall health rating",
              "Triglycerides (baseline)",
              "C-reactive protein (baseline)"
              #"Body Mass Index",
              #"Two Years Stroke Survival",
              #"Two Years MI Survival",
              #"Greenspace 300m from residence",
              #"Water 300m from residence",
              #"Natural env. 300m from residence"
  ), 
  ChartName = c("MI", 
              "stroke",
              "age_entry_years",
              "MVPA_min_PA1", 
              "MVPA_min_PA2",
              "MVPA_min_PA3",
              "ethnicity", 
              "tdi", 
              "education_level", 
              "avg_hh_income",
              "smoking", 
              "alcohol", 
              "processed_meat", 
              "red_meat",
              "fresh_fruit", 
              "cooked_vg", 
              "oily_fish", 
              "non_oily_fish",
              "sex", 
              "fu_time",
              "cancer",  
              "syst_bp",  
              "diast_bp",  
              "hdl_chol",  
              "glucose_blood_biochem",  
              "overall_health_rating",  
              "triglycerides_0",  
              "c_reactive_protein_0" 
              #"BMI",
              #"2_years_survival_stroke",
              #"2_years_survival_MI",
              #"water_300m",
              #"greenspace_300m",
              #"naturalenv_300m"
              )
)


var_names <- varNameDf %>% 
    select(varName, ChartName) %>% 
    tibble::deframe()

dt <- dt %>% 
    rename(!!!var_names)


# create table - one single column
tb <- dt %>%
  dplyr::select(-contains("truncated")) %>%
  dplyr::select(-MVPA_Quant_PA1, -MVPA_Quant_PA2, -MVPA_Quant_PA3, -`2_years_survival_stroke`, -`2_years_survival_MI`,-MVPA_100,-MVPA_150) %>%
  tbl_summary(
    statistic = all_continuous() ~ "{median} ({p25}, {p75})",
    digits = all_continuous() ~ 1,
    missing = "no"  # remove unknowns from table
  ) %>%
  as_flex_table() %>%
  set_header_labels(label = "Baseline Characteristics")


sect_properties <- prop_section(
  page_size = page_size(
    orient = "landscape"
  ),
  type = "continuous",
  page_margins = page_mar(0)
)


print(tb)



### Table by Quantile
#tb <- dt %>% 
  #dplyr::select(-contains("truncated")) %>% 
  #dplyr::select( -MVPA_Quant_PA1, -MVPA_Quant_PA3) %>% 
  #tbl_summary(
    #by = MVPA_Quant_PA2,  
    #statistic = all_continuous() ~ "{mean} ({sd})"
    #digits = all_continuous() ~ 1,
  #) %>% 
  #as_flex_table()


#print(tb)

# Save 
flextable::save_as_docx("Table 1. Distribution of participant characteristics by MVPA - Main Analysis" = tb,  
               path = "testTable1.docx", 
               pr_section = sect_properties
               ) 

```
## Table 2 - subanalaysis (incudes PA4)
```{r}
# Variables to add to the table - this variable cannot be used to select columns now, since cooked_veg is not rendered into summary table 

# Obesity category names can be shortened 
# Note that all vars, except alcohol, do not know and unknown should be met with exclusion 
dt2 <- full_df_PA_2 %>%  dplyr::select(
  fu_time, 
  #fu_time_pa4,
 # `2_years_survival_stroke`,
 # `2_years_survival_MI`,
  MVPA_Quant_PA1,
  MVPA_Quant_PA2,  
  MVPA_Quant_PA3,
  MVPA_Quant_PA4,  
  MVPA_min_PA1,
   MVPA_100,
  MVPA_150,
  MVPA_min_PA2, 
  MVPA_min_PA3,
  MVPA_min_PA4, 
  MI, 
  stroke,
  age_entry_years, 
  ethnicity, 
  sex, 
  education_level,
  avg_hh_income,
  tdi,
  avg_hh_income,
  #BMI,
  #diabetes,
 # depression,
  smoking, 
  alcohol, 
  processed_meat, 
  red_meat,
  oily_fish,
  non_oily_fish,
  fresh_fruit,
  cooked_vg, 
  #water_300m,
  #greenspace_300m,
  #naturalenv_300m,
  MVPA_Quant_PA1_truncated, 
  MVPA_Quant_PA2_truncated,
  MVPA_Quant_PA3_truncated, 
  MVPA_Quant_PA4_truncated,
  MVPA_min_PA1_truncated, 
  MVPA_min_PA2_truncated,
  MVPA_min_PA3_truncated,
  MVPA_min_PA4_truncated
)

# Convert variable names into descriptive table names 
varNameDf <- data.frame(
  varName = c("Myocardial infarction",
              "Stroke",
              "Age",
              "MVPA min/week - ENMO",
              "MVPA min/week - Machine learning",
              "MVPA min/week - Activity count",
              "MVPA min/week - Self-report (IPAQ)",
              "Race", 
              #"BMI",
              #"Type II diabetes", 
              #"Depression",
              "Deprivation index", 
              "Education", 
              "Household income GBP",
              "Smoking", 
              "Alcohol consumption", 
              "Processed meat",
              "Red meat",
              "Fresh fruit", 
              "Cooked vegetables", 
              "Oily fish", 
              "Non-oily fish",
              "Sex", 
              "Follow up time in months"
              #"Follow up time in for self-reported PA"
             # "Two years stroke survival",
             # "Two years MI survival",              
              #"Greenspace 300m from residence",
              #"Water 300m from residence",
              #"Natural env. 300m from residence"
  ), 
  ChartName = c("MI", 
              "stroke",
              "age_entry_years",
              "MVPA_min_PA1", 
              "MVPA_min_PA2",
              "MVPA_min_PA3",
              "MVPA_min_PA4",
              "ethnicity", 
              #"BMI",
              #"diabetes", 
              #"depression",
              "tdi", 
              "education_level", 
              "avg_hh_income",
              "smoking", 
              "alcohol", 
              "processed_meat", 
              "red_meat",
              "fresh_fruit", 
              "cooked_vg", 
              "oily_fish", 
              "non_oily_fish",
              "sex", 
              "fu_time"
              #"fu_time_pa4"
              #"2_years_survival_stroke",
              #"2_years_survival_MI",
              #"water_300m",
              #"greenspace_300m",
              #"naturalenv_300m"
  )
)

var_names <- varNameDf %>% 
    select(varName, ChartName) %>% 
    tibble::deframe()

dt2 <- dt2 %>% 
    rename(!!!var_names)



# create table - one single column
tb2 <- dt2 %>%
  dplyr::select(-contains("truncated")) %>%
  dplyr::select(-MVPA_Quant_PA1, -MVPA_Quant_PA2, -MVPA_Quant_PA3, -MVPA_Quant_PA4,-MVPA_100,-MVPA_150) %>%
  tbl_summary(
    statistic = all_continuous() ~ "{median} ({p25}, {p75})", 
    digits = all_continuous() ~ 1,
    missing = "no" 
  ) %>%
  as_flex_table() %>%
  set_header_labels(label = "Baseline Characteristics")


sect_properties <- prop_section(
  page_size = page_size(
    orient = "landscape"
  ),
  type = "continuous",
  page_margins = page_mar(0)
)


print(tb2)



print(tb2)

# Save 
flextable::save_as_docx("Table 2.1. Distribution of participant characteristics by MVPA - Including PA4" = tb2,  
               path = "testTable2_pa4.docx", 
               pr_section = sect_properties
)

```


## Create dt3 - PA1, PA2 & PA3 - with mediator
```{r}
# Variables to add to the table - this variable cannot be used to select colum,ns now, since cooked_veg is not rendred into summary table 


dt3 <- full_df_PA %>%  dplyr::select(
  fu_time, 
  `2_years_survival_stroke`,
  `2_years_survival_MI`,
   MVPA_Quant_PA1,
   MVPA_Quant_PA2,  
  MVPA_Quant_PA3,
  #MVPA_Quant_PA4,  
  MVPA_min_PA1,
  MVPA_100,
  MVPA_150,
  MVPA_min_PA2,
  MVPA_min_PA3,
 # MVPA_min_PA4, 
  MI, 
  stroke,
  age_entry_years, 
  ethnicity, 
  sex, 
  education_level,
  tdi,
  avg_hh_income,
  BMI,
  diabetes,
  depression,
  smoking, 
  alcohol, 
  processed_meat, 
  red_meat,
  oily_fish,
  non_oily_fish,
  fresh_fruit,
  cooked_vg,
  water_300m,
  greenspace_300m,
  naturalenv_300m,
  MVPA_Quant_PA1_truncated, 
  MVPA_Quant_PA2_truncated,
  MVPA_Quant_PA3_truncated,
  #MVPA_Quant_PA4_truncated,
  MVPA_min_PA1_truncated, 
  MVPA_min_PA2_truncated,
  MVPA_min_PA3_truncated,
  #MVPA_min_PA4_truncated,
  )



# Convert variable names into desruptive table names 
varNameDf <- data.frame(
  varName = c("Myocardial infarction",
              "Stroke",
              "Age",
              "MVPA min/week - ENMO",
              "MVPA min/week - Machine learning",
              "MVPA min/week - Activity count",
              #"Race", 
              "Deprivation index", 
              #"Education", 
              #"Household income GBP",
              #"Smoking", 
              #"Alcohol consumption", 
              #"Processed meat",
              #"Red meat",
              #"Fresh fruit", 
              #"Cooked vegetables", 
              #"Oily fish", 
              #"Non-oily fish",
              "Sex", 
              "Follow up time in months", 
              "Body mass index",
              "Type II diabetes",
              "Depression",
              "Two years stroke survival",
              "Two years MI survival"
              #"Greenspace 300m from residence",
              #"Water 300m from residence",
              #"Natural env. 300m from residence"
  ), 
  ChartName = c("MI", 
              "stroke",
              "age_entry_years",
              "MVPA_min_PA1", 
              "MVPA_min_PA2",
              "MVPA_min_PA3",
              #"ethnicity", 
              "tdi", 
              #"education_level", 
              #"avg_hh_income",
              #"smoking", 
             #"alcohol", 
              #"processed_meat", 
              #"red_meat",
              #"fresh_fruit", 
              #"cooked_vg", 
              #"oily_fish", 
              #"non_oily_fish",
              "sex", 
              "fu_time", 
              "BMI",
              "diabetes",
              "depression",
              "2_years_survival_stroke",
              "2_years_survival_MI"
             # "water_300m",
              #"greenspace_300m",
              #"naturalenv_300m"
              )
)


var_names <- varNameDf %>% 
    select(varName, ChartName) %>% 
    tibble::deframe()

dt3 <- dt3 %>% 
    rename(!!!var_names)


tb3 <- dt3 %>%
  dplyr::select(-contains("truncated")) %>%
  dplyr::select(-MVPA_Quant_PA1, -MVPA_Quant_PA2, -MVPA_Quant_PA3,-MVPA_100,-MVPA_150) %>%
  tbl_summary(
    statistic = all_continuous() ~ "{median} ({p25}, {p75})", 
    digits = all_continuous() ~ 1,
    missing = "no"  
  ) %>%
  as_flex_table() %>%
  set_header_labels(label = "Baseline Characteristics")



# Save 
flextable::save_as_docx("Table 2.2. Distribution of participant characteristics by MVPA - Mediators " = tb3,  
               path = "testTable2_mediator.docx", 
               pr_section = sect_properties)
```


## Create dt4 - Greeness
```{r}

dt4 <- full_df_PA %>%  dplyr::select(
  fu_time, 
  `2_years_survival_stroke`,
  `2_years_survival_MI`,
    MVPA_Quant_PA1,
  MVPA_Quant_PA2,  
  MVPA_Quant_PA3,
  #MVPA_Quant_PA4,  
  MVPA_min_PA1,
  MVPA_100,
  MVPA_150,
  MVPA_min_PA2,
  MVPA_min_PA3,
 # MVPA_min_PA4, 
  MI, 
  stroke,
  age_entry_years, 
  #ethnicity, 
  sex, 
  education_level,
  #tdi,
  water_300m,
  greenspace_300m,
  naturalenv_300m
  )

dt4 <- na.omit(dt4) # remove rows for which there are NAs for greeness and blueness

# Convert variable names into desruptive table names 
varNameDf <- data.frame(
  varName = c("Myocardial infarction",
              "Stroke",
              "Age",
              "MVPA min/week - ENMO",
              "MVPA min/week - Machine learning",
              "MVPA min/week - Activity count",
              #"Race", 
              "Sex", 
              "Follow up time in months", 
              "Greenspace 300m from residence",
              "Water 300m from residence",
              "Natural env. 300m from residence"
  ), 
  ChartName = c("MI", 
              "stroke",
              "age_entry_years",
              "MVPA_min_PA1", 
              "MVPA_min_PA2",
              "MVPA_min_PA3",
              #"ethnicity", 
              #"tdi", 
              #"education_level", 
              #"avg_hh_income",
              #"smoking", 
             #"alcohol", 
              #"processed_meat", 
              #"red_meat",
              #"fresh_fruit", 
              #"cooked_vg", 
              #"oily_fish", 
              #"non_oily_fish",
              "sex", 
              "fu_time", 
              "greenspace_300m",
              "water_300m",
              "naturalenv_300m"
              )
)


var_names <- varNameDf %>% 
    select(varName, ChartName) %>% 
    tibble::deframe()

dt4 <- dt4 %>% 
    rename(!!!var_names)


tb4 <- dt4 %>%
  tbl_summary(
    statistic = all_continuous() ~ "{median} ({p25}, {p75})", 
    digits = all_continuous() ~ 1,
    missing = "no"  
  ) %>%
  as_flex_table() %>%
  set_header_labels(label = "Baseline Characteristics")



# Save 
flextable::save_as_docx("Table 2.3. Distribution of participant characteristics by MVPA - Greenspace and Bluespace " = tb4,  
               path = "testTable2_greenspace_bluespace.docx", 
               pr_section = sect_properties)
```



Create dt8 - new PA1 and PA3 data
```{r}

```


```{r}

saveRDS(dt, "/home/yacine/dataframes_AccelerometerProcessing/prepped_dt.rds")
saveRDS(dt2, "/home/yacine/dataframes_AccelerometerProcessing/prepped_dt2.rds")
saveRDS(dt3, "/home/yacine/dataframes_AccelerometerProcessing/prepped_dt3.rds")
saveRDS(dt4, "/home/yacine/dataframes_AccelerometerProcessing/prepped_dt4.rds")

```




### Histograms
```{r}
png("MVPA_histograms.png", width = 800, height = 800)
par(mfrow = c(2,2))
hist(dt$`MVPA min/week - ENMO`, xlab = "minutes", main = "Duration MVPA min - ENMO")
hist(dt$`MVPA min/week - Machine learning`, xlab = "minutes", main = "Duration MVPA min - Machine Learning")
hist(dt$`MVPA min/week - Activity count`, xlab = "minutes", main = "Duration MVPA min - Activity Count")
hist(dt2$`MVPA min/week - Self-report (IPAQ)`, xlab = "minutes", main = "Duration MVPA min - Self-Report (IPAQ)")
dev.off()

```
Function to label the plots: 
```{r}

# source: https://logfc.wordpress.com/2017/03/15/adding-figure-labels-a-b-c-in-the-top-left-corner-of-the-plotting-region/

fig_label <- function(text, region = "plot", pos = "topleft", cex = 1.2, x_adj = -0.1, y_adj = -0.03, ...) {
  region <- match.arg(region, c("figure", "plot", "device"))
  pos <- match.arg(pos, c("topleft", "top", "topright",
                          "left", "center", "right",
                          "bottomleft", "bottom", "bottomright"))
  
  if (region == "plot") {
    u <- par("usr")  
    x <- u[1:2]
    y <- u[3:4]
  } else {
    stop("This function is configured for 'plot' region only.")
  }
  

  x1 <- switch(pos,
               topleft = x[1] + (x[2] - x[1]) * x_adj,
               left = x[1] + (x[2] - x[1]) * x_adj,
               bottomleft = x[1] + (x[2] - x[1]) * x_adj,
               top = (x[1] + x[2]) / 2,
               center = (x[1] + x[2]) / 2,
               bottom = (x[1] + x[2]) / 2,
               topright = x[2] - (x[2] - x[1]) * x_adj,
               right = x[2] - (x[2] - x[1]) * x_adj,
               bottomright = x[2] - (x[2] - x[1]) * x_adj)
  
  y1 <- switch(pos,
               topleft = y[2] + (y[1] - y[2]) * y_adj,
               top = y[2] + (y[1] - y[2]) * y_adj,
               topright = y[2] + (y[1] - y[2]) * y_adj,
               left = (y[1] + y[2]) / 2,
               center = (y[1] + y[2]) / 2,
               right = (y[1] + y[2]) / 2,
               bottomleft = y[1] - (y[1] - y[2]) * y_adj,
               bottom = y[1] - (y[1] - y[2]) * y_adj,
               bottomright = y[1] - (y[1] - y[2]) * y_adj)
  
  old.par <- par(xpd = NA)
  on.exit(par(old.par))
  
  text(x1, y1, text, cex = cex, font = 2, ...)
  return(invisible(c(x, y)))
}

```

```{r}

png("MVPA_histograms.png", width = 2250, height = 2250, res = 300) 
par(mfrow = c(2, 2), family = "Arial", ps = 12, oma = c(0, 0, 0, 0), mar = c(4, 4, 2, 1)) 

# Histogram 1
hist(dt$`MVPA min/week - ENMO`,
     xlab = "",
      main = "", 
     cex.axis = 1, cex.lab = 1.2, cex.main = 1.4) 
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.2, y_adj = -0.05)

# Histogram 2
hist(dt$`MVPA min/week - Machine learning`,
     xlab = "",
     ylab = "",
      main = "",
     cex.axis = 1, cex.lab = 1.2, cex.main = 1.4)
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.2, y_adj = -0.05)

# Histogram 3
hist(dt$`MVPA min/week - Activity count`,
     xlab = "Minutes",
      main = "", 
     cex.axis = 1, cex.lab = 1.2, cex.main = 1.4)
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.2, y_adj = -0.05)

# Histogram 4
hist(dt2$`MVPA min/week - Self-report (IPAQ)`,
     xlab = "Minutes",
      ylab = "",
      main = "", 
     cex.axis = 1, cex.lab = 1.2, cex.main = 1.4)
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.2, y_adj = -0.05)

dev.off()


```