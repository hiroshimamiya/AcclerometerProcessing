---
title: "spline_script"
author: "yacine"
date: "2024-10-11"
output: html_document
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Refresh environment 
rm(list= ls())
library(dplyr)
library(survival)
library(data.table)
library(readr)
library(dvmisc)
library(gtsummary)
library(gt)
library(kableExtra)
library(broom.helpers)
library(flextable)
library(officer)
library(ggplot2)
library(splines)
library(splines2)
#install.packages("splines2")
splines::bs
splines2::bSpline

theme_gtsummary_journal("jama")
```

## We load the data:
```{r}
#dt <- readRDS("/home/yacine/UKBB_beluga/prepped_dt.rds") # full df with exclusions + recoding and all data prepared for survival analysis
dt <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt.rds")
dt2 <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt2.rds")
```


## Spline

Restricted Cubic Spline : relationship is non-linear
- Number of knots: "five knots are enough to provide a good fit to any patterns 
  that are likely to arise in practice." (Stone, 1986)
quote from: https://support.sas.com/resources/papers/proceedings16/5621-2016.pdf
source: Stone, C. J. (1986). [Generalized Additive Models: Comment]. Statistical Science, 1(3), 312-314.
- However, our model is not smooth with 5 knots
```{r}

# in order for the bs function to work, we need to transform the MVPA_Quant_PA# 
# data into numerical values
dt$`MVPA min/week` <- as.numeric(dt$`MVPA min/week`)
dt$`MVPA min/week ML` <- as.numeric(dt$`MVPA min/week ML`)
dt$`MVPA min/week Activity Count` <- as.numeric(dt$`MVPA min/week Activity Count`)


pdf("/home/yacine/termplots.pdf") 


# we apply a spline to the coxph model
# PA1
fit1_smooth_stroke <- coxph(Surv(`Follow_up time`, Stroke) ~ 
                       bs(`MVPA min/week`, df = 4), data = dt)

fit1_smooth_MI <- coxph(Surv(`Follow_up time`, `Myocardial Infarction`) ~ 
                       bs(`MVPA min/week`, df = 4), data = dt)

par(ask = FALSE) 
termplot(fit1_smooth_stroke, se = TRUE, partial.resid = TRUE, main = "Stroke PA1", ylim = c(-1.5,2.5), rug = TRUE)
termplot(fit1_smooth_MI, se = TRUE, partial.resid = TRUE, main = "MI PA1")


# PA2
fit2_smooth_stroke <- coxph(Surv(`Follow_up time`, Stroke) ~ 
                       bs(MVPA_Quant_PA2, df = 4), data = dt)

fit2_smooth_MI <- coxph(Surv(`Follow_up time`, `Myocardial Infarction`) ~ 
                       bs(MVPA_Quant_PA2, df = 4), data = dt)

par(ask = FALSE) 
termplot(fit2_smooth_stroke, se = TRUE, partial.resid = TRUE, main = "Stroke PA2")
termplot(fit2_smooth_MI, se = TRUE, partial.resid = TRUE, main = "MI PA2")


# PA3
fit3_smooth_stroke <- coxph(Surv(`Follow_up time`, Stroke) ~ 
                       bs(MVPA_Quant_PA3, df = 4), data = dt)

fit3_smooth_MI <- coxph(Surv(`Follow_up time`, `Myocardial Infarction`) ~ 
                       bs(MVPA_Quant_PA3, df = 4), data = dt)

par(ask = FALSE) 
termplot(fit3_smooth_stroke, se = TRUE, partial.resid = TRUE, main = "Stroke PA3")
termplot(fit3_smooth_MI, se = TRUE, partial.resid = TRUE, main = "MI PA3")

dev.off()

```