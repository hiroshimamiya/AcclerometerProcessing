---
title: "spline_script"
author: "yacine"
date: "2024-10-11"
output: html_document
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Refresh environment 


rm(list= ls())
#install.packages("splines2")
#install.packages("rms")
#install.packages('Greg')
library(dplyr)
library(survival)
library(readr)
library(ggplot2)
library(splines)
library(splines2)
library(rms)
library(Greg)
library(data.table)
library(readr)
library(dvmisc)
library(gtsummary)
library(gt)
library(kableExtra)
library(broom.helpers)
library(flextable)
library(officer)
library(ggplot2)
library(splines)
library(splines2)
library(survminer)

splines::bs
splines2::bSpline

#theme_gtsummary_journal("jama")
```

## We load the data:
```{r}
#dt <- readRDS("/home/yacine/UKBB_beluga/prepped_dt.rds") # full df with exclusions + recoding and all data prepared for survival analysis
dt <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt.rds")
dt2 <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt2.rds")
```


## Spline Cox PH fit Using the rms Package:
```{r}

# Renaming the variables for MVPA and Follow-up time (crucial for coxph function to work)
dt <- dt %>% rename(fu_time = `Follow_up time`,
                    MI = `Myocardial Infarction`,
                    mvpa1 = `MVPA min/week`,
                    mvpa2 = `MVPA min/week Machine Learning`,
                    mvpa3 = `MVPA min/week Activity Count`,
                    deprivation_index = `Deprivation index`,
                    hh_income = `Household Income`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`,
                    type_2_diab = `Type II Diabetes`,
                    bmi = `Body Mass Index`
                    )

dt2 <- dt2 %>% rename(fu_time = `Follow_up time`,
                    MI = `Myocardial Infarction`,
                    mvpa4 = `MVPA min/week Self-Report (IPAQ)`,
                     deprivation_index = `Deprivation index`,
                    hh_income = `Household Income`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`,
                    type_2_diab = `Type II Diabetes`,
                    bmi = `Body Mass Index`
)


# *** Note: We determined the optimal number of knots (nk) for each PA measure using AIC testing.The function only allows nk >= 3. Therefore, the number of knots used corresponds to the lowest AIC value for each.
# As a result, we determined the optimal nk was 4 for PA1 and PA2, and 3 for PA3 and PA4.

# PA1
fit_pa1_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4), data = dt)
fit_pa1_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4), data = dt)

# PA2
fit_pa2_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3), data = dt)
fit_pa2_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3), data = dt)

# PA3
fit_pa3_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3), data = dt)
fit_pa3_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3), data = dt)

# PA4
fit_pa4_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3), data = dt2)
fit_pa4_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3), data = dt2)


```



## Plotting Spline Cox PH Model Using the plotHR Function:
```{r}


# PA1
## Stroke
png("PA1_Stroke.png", width = 800, height = 600)
plotHR(fit_pa1_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U"
)
dev.off()

## MI
png("PA1_MI.png", width = 800, height = 600)
plotHR(fit_pa1_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Mycordial Infarction Risk \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

# PA2
## Stroke
png("PA2_Stroke.png", width = 800, height = 600)
plotHR(fit_pa2_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Machine Learning",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

## MI
png("PA2_MI.png", width = 800, height = 600)
plotHR(fit_pa2_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Mycordial Infarction Risk \nby Physical Activity - Machine Learning",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

# PA3
## Stroke
png("PA3_Stroke.png", width = 800, height = 600)
plotHR(fit_pa3_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

## MI
png("PA3_MI.png", width = 800, height = 600)
plotHR(fit_pa3_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Mycordial Infarction Risk \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

# PA4
## Stroke
png("PA4_Stroke.png", width = 800, height = 600)
plotHR(fit_pa4_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Self-Report (IPAQ)",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()

## MI
png("PA4_MI.png", width = 800, height = 600)
plotHR(fit_pa4_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Mycordial Infarction Risk \nby Physical Activity - Self-Report (IPAQ)",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U" 
)
dev.off()


```

## Main analysis

### Stroke 
Does not include diabetes, bmi and depression and PA4
```{r}

# PA1
## AIC(nk=3) > AIC(nk=4) 
fit_pa1_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat + bmi, data = dt)


# PA2
## AIC(nk=3) > AIC(nk=4) 
fit_pa2_stroke_nk3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)

fit_pa2_stroke_nk4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat, data = dt)


#PA3
## AIC(nk=3) < AIC(nk=4) 
fit_pa3_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)



### Plotting

# PA1
## Stroke
png("PA1_Stroke_main.png", width = 800, height = 600)
plotHR(fit_pa1_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       ref = 1
)
dev.off()

# PA2
## Stroke

### knots = 3
png("PA2_Stroke_nk3_main.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_nk3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

### knots = 4
png("PA2_Stroke_nk4_main.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_nk4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 4",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA3
## Stroke
png("PA3_Stroke_main.png", width = 800, height = 600)
plotHR(fit_pa3_stroke,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()



```


## Sensitivity analysis:

### We create formulas for covariate
```{r}

f_cov <- "Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi + Depression"

f_cov_noMediator <- "Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish"

#as.formula(paste("Surv(`Follow_up time`,`Myocardial Infarction`) ~ ", "MVPA_Quant_PA2 + ",  f_cov))  
#as.formula(paste(f_stroke, " ~" ,  "MVPA_Quant_PA2 + ",  f_cov))

```


### MI
```{r}

# PA1
#AIC(nk=3) > AIC(nk=4)

fit_pa1_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)



# PA2
#AIC(nk=3) < AIC(nk=4)
fit_pa2_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)



#PA3
#AIC(nk=3) < AIC(nk=4)
fit_pa3_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)

### Plotting

# PA1
## MI
png("PA1_MI_main.png", width = 800, height = 600)
plotHR(fit_pa1_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of MI \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U",
       refline = 1
)
dev.off()


# PA2
## MI
png("PA2_MI_main.png", width = 800, height = 600)
plotHR(fit_pa2_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of MI \nby Physical Activity - Machine Learning",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U",
       refline = 1
)
dev.off()


# PA3
## Stroke
png("PA3_MI_main.png", width = 800, height = 600)
plotHR(fit_pa3_MI,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of MI \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U",
       refline = 1
)
dev.off()



```


## Sensitivity analysis 1 - No Mediator, without BMI and Diabetes

### Stroke
```{r}
# PA1
fit_pa1_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish, data = dt)


# PA2
fit_pa2_stroke_nk3_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)

fit_pa2_stroke_nk4_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)


#PA3
fit_pa3_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)


#PA4 
fit_pa4_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt2)



### Plotting

# PA1
## MI
png("fit_pa1_stroke_sa1.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Stroke \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA2
## MI
png("fit_pa2_stroke_nk3_sa1.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_nk3_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA3
## MI
png("fit_pa3_stroke_sa1.png", width = 800, height = 600)
plotHR(fit_pa3_stroke_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA4
## MI
### 3 knots
png("fit_pa4_stroke_sa1.png", width = 800, height = 600)
plotHR(fit_pa4_stroke_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Stroke \nby Physical Activity - Self-Report (IPAQ)",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()


```


### MI

```{r}
# PA1
fit_pa1_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt)


# PA2
fit_pa2_mi_nk3_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)

fit_pa2_mi_nk4_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt)


#PA3
fit_pa3_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt)


#PA4 
fit_pa4_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt2)



### Plotting

# PA1
## MI
png("fit_pa1_mi_sa1.png", width = 800, height = 600)
plotHR(fit_pa1_mi_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Myocardial Infarction \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA2
## MI
### knots = 3
png("fit_pa2_mi_nk3_sa1.png", width = 800, height = 600)
plotHR(fit_pa2_mi_nk3_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Myocardial Infarction \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

### knots = 4
png("fit_pa2_mi_nk4_sa1.png", width = 800, height = 600)
plotHR(fit_pa2_mi_nk4_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Myocardial Infarction \nby Physical Activity - Machine Learning \nknots = 4",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA3
## MI
png("fit_pa3_mi_sa1.png", width = 800, height = 600)
plotHR(fit_pa3_mi_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 1: Hazard of Myocardial Infarction \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA4
## MI
png("fit_pa4_mi_sa1.png", width = 800, height = 600)
plotHR(fit_pa4_mi_sa1,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Cox PH Model for Hazard of Myocardial Infarction \nby Physical Activity - Self-Report (IPAQ)",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()
```



## Sensitivity analysis 2 - Removed people with huge duration (>1200min) of MVPA Stroke 

### Stroke
```{r}


dt <- dt[!is.na(dt$MVPA_min_PA1_truncated), ]
dt <- dt[!is.na(dt$MVPA_min_PA2_truncated), ]
dt <- dt[!is.na(dt$MVPA_min_PA3_truncated), ]


# PA1
fit_pa1_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA1_truncated, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish + type_2_diab + bmi + Depression, data = dt)


# PA2
fit_pa2_stroke_nk3_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA2_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish + type_2_diab + bmi+ Depression, data = dt)

fit_pa2_stroke_nk4_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA2_truncated, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish + type_2_diab + bmi+ Depression, data = dt)


#PA3
fit_pa3_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA3_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt)


#PA4 
fit_pa4_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA4_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt2)



### Plotting

# PA1
## Stroke
png("fit_pa1_stroke_sa2.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of Stroke \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA2
## Stroke
### knots = 3
png("fit_pa2_stroke_nk3_sa2.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_nk3_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

### knots = 4
png("fit_pa2_stroke_nk4_sa2.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_nk4_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 4",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA3
## Stroke
png("fit_pa3_stroke_sa2.png", width = 800, height = 600)
plotHR(fit_pa3_stroke_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA4
## Stroke
png("fit_pa4_stroke_sa2.png", width = 800, height = 600)
plotHR(fit_pa4_stroke_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of Stroke \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()


```
### MI
```{r}
# PA1
fit_pa1_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA1_truncated, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt)


# PA2
fit_pa2_MI_nk3_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA2_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat +type_2_diab + bmi+ Depression, data = dt)



#PA3
fit_pa3_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA3_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt)


#PA4 
fit_pa4_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA4_truncated, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt2)



### Plotting

# PA1
## MI
png("fit_pa1_MI_sa2.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of MI \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA2
## MI
### knots = 3
png("fit_pa2_MI_nk3_sa2.png", width = 800, height = 600)
plotHR(fit_pa2_MI_nk3_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of MI \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA3
## MI
png("fit_pa3_MI_sa2.png", width = 800, height = 600)
plotHR(fit_pa3_stroke_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of MI \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# PA4
## MI
png("fit_pa4_MI_sa2.png", width = 800, height = 600)
plotHR(fit_pa4_stroke_sa2,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 2: Hazard of MI \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()


```

## Sensitivity analysis 3 - Male and Female separate 
See the data source in the regression command

```{r}
# PA1
fit_pa1_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

fit_pa1_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

# PA2
fit_pa2_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

fit_pa2_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

# PA3
fit_pa3_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

fit_pa3_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt[dt$Sex == "Female", ])

# PA4
fit_pa4_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt2[dt2$Sex == "Female", ])

fit_pa4_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + type_2_diab + bmi+ Depression, data = dt2[dt2$Sex == "Female", ])

### Plotting

# PA1
# Stroke
png("fit_pa1_stroke_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of Stroke \nby Physical Activity - Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# MI
png("fit_pa1_MI_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of MI \nby Physical Activity - Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()



# PA2
# Stroke
png("fit_pa2_stroke_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of Stroke \nby Physical Activity - Machine Learning",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# MI
png("fit_pa2_MI_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of MI \nby Physical Activity - Machine Learning",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()


# PA3
# Stroke
png("fit_pa3_stroke_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# MI
png("fit_pa3_MI_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of MI \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()


# PA4
# Stroke
png("fit_pa4_stroke_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of Stroke \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

# MI
png("fit_pa4_MI_sa3.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa3,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 3: Hazard of MI \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1
)
dev.off()

```



## Sensitivity analysis 4 - 2 years of survival 
We perform a sensitivity analysis by first extracting people that have had a stroke
within the 2 following years of the end of the accelerometer tracking ('2_years_survival_stroke' == 0)

### Remove people who have had a Stroke within 2 years following date_end_accel:
```{r}

# we create a new df where we extracted the participants for whom '2_years_survival_stroke' == 0
dt_sa4 <- dt %>%
  filter('Two Years Stroke Survival' != 0)

dt_sa4_2 <- dt2 %>%
  filter('Two Years Stroke Survival' != 0)

```

### Stroke
```{r}
# PA1
fit_pa1_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4 )

# PA2
fit_pa2_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4 )

# PA3
fit_pa3_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4 )

# PA4
fit_pa4_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4_2 )



### Plotting

# PA1
## Stroke
png("fit_pa1_stroke_sa4.png", width = 800, height = 600)
plotHR(fit_pa1_stroke_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of Stroke \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA2
## Stroke
### knots = 3
png("fit_pa2_stroke_sa4.png", width = 800, height = 600)
plotHR(fit_pa2_stroke_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of Stroke \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA3
## Stroke
png("fit_pa3_stroke_sa4.png", width = 800, height = 600)
plotHR(fit_pa3_stroke_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of Stroke \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA4
## Stroke
png("fit_pa4_stroke_sa4.png", width = 800, height = 600)
plotHR(fit_pa4_stroke_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of Stroke \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()




```


### MI
```{r}
# PA1
fit_pa1_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4)

# PA2
fit_pa2_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4)

# PA3
fit_pa3_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4)

# PA4
fit_pa4_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi+ Depression, data = dt_sa4_2)

### Plotting

# PA1
## MI
png("fit_pa1_MI_sa4.png", width = 800, height = 600)
plotHR(fit_pa1_MI_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of MI \nby Physical Activity Vector Magnitude (ENMO)",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA2
## MI
### knots = 3
png("fit_pa2_MI_sa4.png", width = 800, height = 600)
plotHR(fit_pa2_MI_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of MI \nby Physical Activity - Machine Learning \nknots = 3",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA3
## MI
png("fit_pa3_MI_sa4.png", width = 800, height = 600)
plotHR(fit_pa3_MI_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of MI \nby Physical Activity - Activity Count",
       xlim = c(0, 1500),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()

# PA4
## MI
png("fit_pa4_MI_sa4.png", width = 800, height = 600)
plotHR(fit_pa4_MI_sa4,
       term = 1,
       xlab = "PA Duration (minutes/week)",
       main = "Sensitivity analysis 4: Hazard of MI \nby Physical Activity - Self-Report",
       xlim = c(0, 2000),
       ylim = c(0.2, 4),
       plot.bty = "U",
       refline = 1)
dev.off()


```

