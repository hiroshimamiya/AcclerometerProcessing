---
title: "spline_script"
author: "yacine"
date: "2024-10-11"
output: html_document
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Refresh environment 


rm(list= ls())
#install.packages("splines2")
#install.packages("rms")
#install.packages('Greg')
library(dplyr)
library(survival)
#library(data.table)
library(readr)
#library(dvmisc)
#library(gtsummary)
#library(gt)
#library(kableExtra)
#library(broom.helpers)
#library(flextable)
#library(officer)
library(ggplot2)
library(splines)
library(splines2)
library(rms)
library(Greg)

splines::bs
splines2::bSpline

#theme_gtsummary_journal("jama")
```

## We load the data:
```{r}
#dt <- readRDS("/home/yacine/UKBB_beluga/prepped_dt.rds") # full df with exclusions + recoding and all data prepared for survival analysis
dt <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt.rds")
dt2 <- readRDS("/home/yacine/AcclerometerProcessing/prepped_dt2.rds")
```


## Spline Cox PH fit Using the rms Package:
```{r}

# Renaming the variables for MVPA and Follow-up time (crucial for coxph function to work)
dt <- dt %>% rename(fu_time = `Follow_up time`,
                    MI = `Myocardial Infarction`,
                    mvpa1 = `MVPA min/week`,
                    mvpa2 = `MVPA min/week ML`,
                    mvpa3 = `MVPA min/week Activity Count`
                    )

dt2 <- dt2 %>% rename(fu_time = `Follow_up time`,
                      MI = `Myocardial Infarction`,
                      mvpa4 = `MVPA min/week Self-Report`
                      )


# *** Note: We determined the optimal number of knots (nk) for each PA measure using AIC testing.The function only allows nk >= 3. Therefore, the number of knots used corresponds to the lowest AIC value for each.
# As a result, we determined the optimal nk was 4 for PA1 and PA2, and 3 for PA3 and PA4.

# PA1
fit_pa1_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4), data = dt)
fit_pa1_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4), data = dt)

# PA2
fit_pa2_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4), data = dt)
fit_pa2_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 4), data = dt)

# PA3
fit_pa3_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3), data = dt)
fit_pa3_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3), data = dt)

# PA4
fit_pa4_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3), data = dt2)
fit_pa4_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3), data = dt2)


```


## Plotting Spline Cox PH Model Using the plotHR Function:
```{r}


# PA1
## Stroke
plotHR(fit_pa1_stroke,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Stroke Risk \nby Physical Activity (PA1)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U"
)

## MI
plotHR(fit_pa1_MI,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Mycordial Infarction Risk \nby Physical Activity (PA1)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U" 
)


# PA2
## Stroke
plotHR(fit_pa2_stroke,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Stroke Risk \nby Physical Activity - ML (PA2)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U" 
)

## MI
plotHR(fit_pa2_MI,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Mycordial Infarction Risk \nby Physical Activity - ML (PA2)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U" 
)



# PA3
## Stroke
plotHR(fit_pa3_stroke,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Stroke Risk \nby Physical Activity - Activity Count (PA3)",
       xlim = c(0, 4000),
       ylim = c(0.2,4),
       plot.bty = "U" 
)

## MI
plotHR(fit_pa3_MI,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Mycordial Infarction Risk \nby Physical Activity - Activity Count (PA3)",
       xlim = c(0, 4000),
       ylim = c(0.2,4),
       plot.bty = "U" 
)




# PA4
## Stroke
plotHR(fit_pa4_stroke,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Stroke Risk \nby Physical Activity - Self-Report (PA4)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U" 
)

## MI
plotHR(fit_pa4_MI,
       term = 1,
       xlab = "Weekly Activity (minutes/week)",
       main = "Cox PH Model for Mycordial Infarction Risk \nby Physical Activity - Self-Report (PA4)",
       xlim = c(0, 1500),
       ylim = c(0.2,4),
       plot.bty = "U" 
)


```



