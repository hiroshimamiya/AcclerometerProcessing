---
title: "spline_script"
author: "yacine"
date: "2024-10-11"
output: html_document
---

We load and/or install the packages we will be using:

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Refresh environment 


rm(list= ls())
#install.packages("splines2")
#install.packages("rms")
#install.packages('Greg')
library(dplyr)
library(survival)
library(readr)
library(ggplot2)
library(splines)
library(splines2)
library(rms)
library(Greg)
library(data.table)
library(readr)
library(dvmisc)
library(gtsummary)
library(gt)
library(kableExtra)
library(broom.helpers)
library(flextable)
library(officer)
library(ggplot2)
library(splines)
library(splines2)
library(survminer)

splines::bs
splines2::bSpline

#theme_gtsummary_journal("jama")
```

## We load the data:
```{r}
#dt <- readRDS("/home/yacine/UKBB_beluga/prepped_dt.rds") # full df with exclusions + recoding and all data prepared for survival analysis
dt <- readRDS("/home/yacine/dataframes_AccelerometerProcessing/prepped_dt.rds")
dt2 <- readRDS("/home/yacine/dataframes_AccelerometerProcessing/prepped_dt2.rds")
dt3 <- readRDS("/home/yacine/dataframes_AccelerometerProcessing/prepped_dt3.rds")
dt8 <- readRDS("/home/yacine/dataframes_AccelerometerProcessing/prepped_dt8.rds")
dt_original <- dt


```
Histograms
```{r}
summary(dt2$`MVPA min/week - Self-report (IPAQ)`)
hist(dt2$`MVPA min/week - Self-report (IPAQ)`)

par(mfrow=c(4,3))
  hist(dt$`MVPA min/week - ENMO`, main = "Dt, MVPA1"); 
  hist(dt2$`MVPA min/week - ENMO`, main = "Dt2, MVPA1"); 
  hist(dt3$`MVPA min/week - ENMO`, main = "Dt3, MVPA1"); 

  
  hist(dt$`MVPA min/week - Machine learning`, main = "Dt, MVPA2"); 
  hist(dt2$`MVPA min/week - Machine learning`, main = "Dt2, MVPA2"); 
  hist(dt3$`MVPA min/week - Machine learning`, main = "Dt3, MVPA2"); 
  
  
  hist(dt$`MVPA min/week - Activity count`, main = "Dt, MVPA3"); 
  hist(dt2$`MVPA min/week - Activity count`, main = "Dt2, MVPA3"); 
  hist(dt3$`MVPA min/week - Activity count`, main = "Dt3, MVPA3"); 
  
  
  hist(dt2$`MVPA min/week - Self-report (IPAQ)`, main = "Dt2, MVPA4")
dev.off()


```




## Spline Cox PH fit Using the rms Package:
```{r}

# Renaming the variables for MVPA and Follow-up time (crucial for coxph function to work)
dt <- dt %>% rename(fu_time = `Follow up time in months`,
                    MI = `Myocardial infarction`,
                    mvpa1 = `MVPA min/week - ENMO`,
                    mvpa2 = `MVPA min/week - Machine learning`,
                    mvpa3 = `MVPA min/week - Activity count`,
                    deprivation_index = `Deprivation index`,
                    hh_income = `Household income GBP`,
                    Alcohol = `Alcohol consumption`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`
                    #type_2_diab = `Type II Diabetes`,
                    #bmi = `Body Mass Index`
                    )


# Dataset including PA4 (self-report) 
dt2 <- dt2 %>% rename(fu_time = `Follow up time in months`,
                    MI = `Myocardial infarction`,
                    mvpa1 = `MVPA min/week - ENMO`,
                    mvpa2 = `MVPA min/week - Machine learning`,
                    mvpa3 = `MVPA min/week - Activity count`,
                    mvpa4 = `MVPA min/week - Self-report (IPAQ)`,
                    deprivation_index = `Deprivation index`,
                    hh_income = `Household income GBP`,
                    Alcohol = `Alcohol consumption`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`
                    #type_2_diab = `Type II diabetes`,
                    #bmi = `Body mass index`,
)

# Includes bmi, depression and diabetes (I made it seperate from dt because it was easier to call the variables that way but I can figure out a way to make it “dt” if it’s too confusing) and exludes PA4
dt3 <- dt3 %>% rename(fu_time = `Follow up time in months`,
                    MI = `Myocardial infarction`,
                    mvpa1 = `MVPA min/week - ENMO`,
                    mvpa2 = `MVPA min/week - Machine learning`,
                    mvpa3 = `MVPA min/week - Activity count`,
                    deprivation_index = `Deprivation index`,
                    #hh_income = `Household income GBP`,
                    #pro_meat = `Processed meat`,
                    #red_meat = `Red meat`,
                    #fresh_fruit = `Fresh fruit`,
                    #cooked_vg = `Cooked vegetables`,
                    #oily_fish = `Oily fish`,
                    #non_oily_fish = `Non-oily fish`,
                    type_2_diab = `Type II diabetes`,
                    bmi = `Body mass index`
                    )

# *** Note: We determined the optimal number of knots (nk) for each PA measure using AIC testing.The function only allows nk >= 3. Therefore, the number of knots used corresponds to the lowest AIC value for each.
# As a result, we determined the optimal nk was 4 for PA1 and PA2, and 3 for PA3 and PA4.


```



#### Check number of records with missingness for each dataframe
```{r}
cat(" ---- Main data ---- \n")
dim(dt); #names(dt); 
sum(complete.cases(dt %>% select(!contains("truncated"))))

cat(" ---- PA4 data ---- \n")
dim(dt2); 
#names(dt2) ; 
sum(complete.cases(dt2)); sum(complete.cases(dt2 %>% select(!contains("truncated"))))


cat(" ---- Mediator data ---- \n")
dim(dt3); 
#names (dt3); 
sum(complete.cases(dt3)); sum(complete.cases(dt3 %>% select(!contains("truncated"))))
```


## Main analysis

### Stroke and MI
Does not include diabetes, bmi and depression and PA4
```{r}

# PA1
## AIC(nk=3) > AIC(nk=4) 
fit_pa1_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat , data = dt)

#fit_pa1_stroke_nk0 <- coxph(Surv(fu_time, Stroke) ~ mvpa1 + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat , data = dt)

# PA2
## AIC(nk=3) > AIC(nk=4) 
fit_pa2_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)

#fit_pa2_stroke_nk4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat, data = dt)

fit_pa2_stroke_0nk <- coxph(Surv(fu_time, Stroke) ~ mvpa2 + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)

#PA3
## AIC(nk=3) < AIC(nk=4) 
fit_pa3_stroke <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)


#fit_pa3_stroke_nk4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)

```


### MI
```{r}

# PA1
#AIC(nk=3) > AIC(nk=4)

fit_pa1_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)


fit_pa1_MI_nk4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)


# PA2
#AIC(nk=3) < AIC(nk=4)
fit_pa2_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt)



#PA3
#AIC(nk=3) < AIC(nk=4)
fit_pa3_MI <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)


fit_pa3_MI_nk0 <- coxph(Surv(fu_time, MI) ~ mvpa3 + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt)


```



### Model check, default locations for knots with 3 and 4 parameters
```{r}
funcLocKnosRcs <- function(mvpa, kn = 3){
  spK <- rcspline.eval(mvpa, nk = kn, inclx = TRUE) %>% attr("knots")
  #spTerms <- rcs(dt$mvpa1, 4)
  #knots <- attr(spTerms, "parms")
  #print(knots)
  rankdf <- ecdf(mvpa)
  rankVar <- data.frame(rank = rankdf(mvpa)*100, value = mvpa)
  closest_indices <- order(abs(rankVar$value - 377.3030))[1:2]
  indx <- lapply(spK, function(x) order(abs(rankVar$value - x))[1])
  lapply(indx, function(x) rankVar[x, "rank"])
}

funcLocKnosRcs(dt$mvpa1, 4)
```


### Model check, number of observations and covaraites
```{r}
l <- list(fit_pa1_stroke,
fit_pa2_stroke,
fit_pa3_stroke,
fit_pa1_MI,
fit_pa2_MI,
fit_pa3_MI)

# Number of observations 
lapply(l, function(x) x$n) %>% unlist


# Number of covariates and knots 
lapply(l, function(x) length(x$coefficients))

# Number of covariates 
coefs <- lapply(l, function(x){
  coefDf <- x$coefficients  
  coefDf[substr(names(coefDf), 1,3) != "rcs"]
}
) 


coefDf <- data.frame(do.call(cbind, coefs)) %>% purrr::set_names(paste(c(1:6), "Model")) 
# Covariates are misalighed due to different number of spline knots 

par(mar = c(5, 11, 4, 2), mfrow = c(2,3))  # Bottom, Left, Top, Right margins
for(i in 1:ncol(coefDf)){
  coefDf[, i] %>% barplot(names.arg = substr(rownames(coefDf), 1,20), las = 2, horiz = T, main = paste("Model ", i))
}




```


## Plotting the dose-response associations from the main analysis 
Function to label the plots: 
```{r}

# source: https://logfc.wordpress.com/2017/03/15/adding-figure-labels-a-b-c-in-the-top-left-corner-of-the-plotting-region/

fig_label <- function(text, region = "plot", pos = "topleft", cex = 1.2, x_adj = -0.1, y_adj = -0.03, ...) {
  region <- match.arg(region, c("figure", "plot", "device"))
  pos <- match.arg(pos, c("topleft", "top", "topright",
                          "left", "center", "right",
                          "bottomleft", "bottom", "bottomright"))
  
  if (region == "plot") {
    u <- par("usr")  
    x <- u[1:2]
    y <- u[3:4]
  } else {
    stop("This function is configured for 'plot' region only.")
  }
  

  x1 <- switch(pos,
               topleft = x[1] + (x[2] - x[1]) * x_adj,
               left = x[1] + (x[2] - x[1]) * x_adj,
               bottomleft = x[1] + (x[2] - x[1]) * x_adj,
               top = (x[1] + x[2]) / 2,
               center = (x[1] + x[2]) / 2,
               bottom = (x[1] + x[2]) / 2,
               topright = x[2] - (x[2] - x[1]) * x_adj,
               right = x[2] - (x[2] - x[1]) * x_adj,
               bottomright = x[2] - (x[2] - x[1]) * x_adj)
  
  y1 <- switch(pos,
               topleft = y[2] + (y[1] - y[2]) * y_adj,
               top = y[2] + (y[1] - y[2]) * y_adj,
               topright = y[2] + (y[1] - y[2]) * y_adj,
               left = (y[1] + y[2]) / 2,
               center = (y[1] + y[2]) / 2,
               right = (y[1] + y[2]) / 2,
               bottomleft = y[1] - (y[1] - y[2]) * y_adj,
               bottom = y[1] - (y[1] - y[2]) * y_adj,
               bottomright = y[1] - (y[1] - y[2]) * y_adj)
  
  old.par <- par(xpd = NA)
  on.exit(par(old.par))
  
  text(x1, y1, text, cex = cex, font = 2, ...)
  return(invisible(c(x, y)))
}

```




#### Combined Plots - Main Analysis
```{r}
png("images/combined_main_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 1, 1))

source("plotHR_hiroshiFunction.R")

# PA1
## Stroke
plotHR2(fit_pa1_stroke,  
      rescaleHR = T, 
       term = 1, 
       #xlab = "MVPA (minutes/week)", 
      ylab = "Hazard ratio (stroke)", 
       adj = 0, 
       xlim = c(0, 1500), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1,
      col.se = "lightgrey", 
      col.dens = "grey"
      )
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa1_MI_nk4,
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (MI)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1500), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1, 
             col.se = "lightgrey", 
      col.dens = "grey"
       )
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2
## Stroke
plotHR2(fit_pa2_stroke_0nk, 
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (stroke)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1500), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1,
             col.se = "lightgrey", 
      col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa2_MI, 
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (MI)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1500), 
ylim = c(0.1, 1.3),        plot.bty = "U", 
       cex.axis = 1, 
        lwd.term = 1.5,
        lty.term = 1,
      col.se = "lightgrey", 
      col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3 
## Stroke
plotHR2(fit_pa3_stroke, 
      rescaleHR = T, 
      term = 1, 
      xlab = "MVPA (minutes/week)", 
      ylab = "Hazard ratio (stroke)", 
      xlim = c(0, 1500), 
      ylim = c(0.1, 1.3), 
      plot.bty = "U", 
      cex.axis = 1, 
      cex.lab = 1.2,
      lwd.term = 1.5,
      lty.term = 1,
            col.se = "lightgrey", 
      col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa3_MI_nk0, term = 1, 
     rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()

```








* Sensitivity analysis:
We create formulas for covariate (they are currently not working in the rcs function, but ultimately I would like to add them to the functions)
```{r}

f_cov <- "Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + type_2_diab + bmi + Depression"

f_cov_noMediator <- "Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish"

#as.formula(paste("Surv(`Follow_up time`,`Myocardial Infarction`) ~ ", "MVPA_Quant_PA2 + ",  f_cov))  
#as.formula(paste(f_stroke, " ~" ,  "MVPA_Quant_PA2 + ",  f_cov))

```



## Sensitivity analysis 1 - Addition of PA 4

### Stroke
```{r}

# PA1
fit_pa1_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish , data = dt2)

#fit_pa1_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + greenspace + water_res + natural_env , data = dt2)

# PA2
fit_pa2_stroke_sa1<- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish , data = dt2)

#fit_pa2_stroke_nk4_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)


#PA3
fit_pa3_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  , data = dt2)


#PA4 
fit_pa4_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa4, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish , data = dt2)


```


### MI

```{r}
# PA1
fit_pa1_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish , data = dt2)

#fit_pa1_stroke_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + greenspace + water_res + natural_env , data = dt2)

# PA2
fit_pa2_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish , data = dt2)

#fit_pa2_mi_nk4_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt)


#PA3
fit_pa3_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish , data = dt2)


#PA4 
fit_pa4_mi_sa1 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa4, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish , data = dt2)





```




#### Combined Plots
6 plots PA1-3, sameas main, except using dt2, in one figure
```{r}
png("images/combined_sa1_PA13_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

# PA1
plotHR2(fit_pa1_stroke_sa1,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA1 MI
plotHR2(fit_pa1_mi_sa1,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA2
plotHR2(fit_pa2_stroke_sa1,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2 MI
plotHR2(fit_pa2_mi_sa1,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3
## Stroke
plotHR2(fit_pa3_stroke_sa1,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa3_mi_sa1,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()
```



#### Combined Plots, PA4 

2 plots PA4, sameas main, except using dt2, in one figure
```{r}

source("plotHR_hiroshiFunction.R")

png("images/combined_sa1_PA4_scaled.png", width = 2250, height = 1600, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(1, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))
# PA4
## Stroke
plotHR2(fit_pa4_stroke_sa1,
       term = 1,
        rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 2000), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa4_mi_sa1,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 2000), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


dev.off()
```













## Sensitivity analysis 2 - Removed people with huge duration (>1200min) of MVPA Stroke 
### Stroke
```{r}

dt_trunc_1200 <- dt %>%  
  mutate( MVPA_min_PA1_truncated_1200 = ifelse(MVPA_min_PA1_truncated > 1200, NA, MVPA_min_PA1_truncated), 
          MVPA_min_PA2_truncated_1200 = ifelse(MVPA_min_PA2_truncated > 1200, NA, MVPA_min_PA2_truncated),
          MVPA_min_PA3_truncated_1200 = ifelse(MVPA_min_PA3_truncated > 1200, NA, MVPA_min_PA3_truncated)
          ) 


dt_trunc_1200 <- dt_trunc_1200[!is.na(dt_trunc_1200$MVPA_min_PA1_truncated_1200), ]
dt_trunc_1200 <- dt_trunc_1200[!is.na(dt_trunc_1200$MVPA_min_PA2_truncated_1200), ]
dt_trunc_1200 <- dt_trunc_1200[!is.na(dt_trunc_1200$MVPA_min_PA3_truncated_1200), ]



# PA1
fit_pa1_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA1_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish  , data = dt_trunc_1200)


# PA2
fit_pa2_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA2_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt_trunc_1200)

#fit_pa2_stroke_nk4_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA2_truncated_1200, 4) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish, data = dt2)


#PA3
fit_pa3_stroke_sa2 <- coxph(Surv(fu_time, Stroke) ~ rcs(MVPA_min_PA3_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt_trunc_1200)


```
### MI
```{r}
# PA1
fit_pa1_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA1_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt_trunc_1200)


# PA2
fit_pa2_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA2_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish + red_meat , data = dt_trunc_1200)



#PA3
fit_pa3_MI_sa2 <- coxph(Surv(fu_time, MI) ~ rcs(MVPA_min_PA3_truncated_1200, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt_trunc_1200)

```
#### Combined Plots
```{r}
png("images/combined_sa2.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

#Unscaled - NOT RUN 
if(exists("varE")){
  # PA1
  ## Stroke
  plotHR(fit_pa1_stroke_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
        cex.axis = 1, cex.lab = 1.2)
  fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  ## MI
  plotHR(fit_pa1_MI_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
         cex.axis = 1, cex.lab = 1.2)
  fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  # PA2
  plotHR(fit_pa2_stroke_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
        cex.axis = 1, cex.lab = 1.2)
  fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  ## MI
  plotHR(fit_pa2_MI_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
         cex.axis = 1, cex.lab = 1.2)
  fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  # PA3
  ## Stroke
  plotHR(fit_pa3_stroke_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
         cex.axis = 1, cex.lab = 1.2)
  fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  ## MI
  plotHR(fit_pa3_MI_sa2,
         term = 1,
         xlab = "MVPA (minutes/week)",
         xlim = c(0, 1200),
         ylim = c(0.2, 4),
         plot.bty = "U",
         cex.axis = 1, cex.lab = 1.2)
  fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
  
  dev.off()
}






png("images/combined_sa2_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 1, 1))

source("plotHR_hiroshiFunction.R")

# PA1
## Stroke
plotHR2(fit_pa1_stroke_sa2,  
      rescaleHR = T, 
       term = 1, 
       #xlab = "MVPA (minutes/week)", 
      ylab = "Hazard ratio (stroke)", 
       adj = 0, 
       xlim = c(0, 1200), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1,
      col.se = "lightgrey", 
      col.dens = "grey"
      )
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa1_MI_sa2,
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (MI)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1200), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1, 
             col.se = "lightgrey", 
      col.dens = "grey"
       )
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2
## Stroke
plotHR2(fit_pa2_stroke_sa2, 
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (stroke)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1200), 
       ylim = c(0.1, 1.3), 
       plot.bty = "U", 
       cex.axis = 1, 
       cex.lab = 1.2, 
               lwd.term = 1.5,
        lty.term = 1,
             col.se = "lightgrey", 
      col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa2_MI_sa2, 
        rescaleHR = T, 
       term = 1, 
       ylab = "Hazard ratio (MI)", 
       #xlab = "MVPA (minutes/week)", 
       xlim = c(0, 1200), 
ylim = c(0.1, 1.3),        plot.bty = "U", 
       cex.axis = 1, 
        lwd.term = 1.5,
        lty.term = 1,
      col.se = "lightgrey", 
      col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3 
## Stroke
plotHR2(fit_pa3_stroke_sa2, 
      rescaleHR = T, 
      term = 1, 
      xlab = "MVPA (minutes/week)", 
      ylab = "Hazard ratio (stroke)", 
      xlim = c(0, 1200), 
      ylim = c(0.1, 1.3), 
      plot.bty = "U", 
      cex.axis = 1, 
      cex.lab = 1.2,
      lwd.term = 1.5,
      lty.term = 1,
            col.se = "lightgrey", 
      col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa3_MI_sa2, term = 1, 
     rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1200), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()

```












## Sensitivity analysis 3 - Male and Female separate 
See the data source in the regression command

### Female
```{r}
# PA1
fit_pa1_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Female", ])

fit_pa1_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Female", ])

# PA2
fit_pa2_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat  , data = dt[dt$Sex == "Female", ])

fit_pa2_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Female", ])

# PA3
fit_pa3_stroke_sa3 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Female", ])

fit_pa3_MI_sa3 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Female", ])


```
### Male
```{r}
# PA1
fit_pa1_stroke_sa3_m <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Male", ])

#fit_pa1_stroke_sa3_m <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 4) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + greenspace + water_res + natural_env , data = dt[dt$Sex == "Male", ])

fit_pa1_MI_sa3_m <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat  , data = dt[dt$Sex == "Male", ])

#fit_pa1_MI_sa3_m <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 4) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat + greenspace + water_res + natural_env , data = dt[dt$Sex == "Male", ])

# PA2
fit_pa2_stroke_sa3_m <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt[dt$Sex == "Male", ])

fit_pa2_MI_sa3_m <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat , data = dt[dt$Sex == "Male", ])

# PA3
fit_pa3_stroke_sa3_m <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat, data = dt[dt$Sex == "Male", ])

fit_pa3_MI_sa3_m <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish +red_meat  , data = dt[dt$Sex == "Male", ])


```





#### Combined Plots
```{r}

# PA1
png("images/combined_sa3_pa1.png", width = 2200, height = 2250, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(2, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))
## Stroke - Female
plotHR2(fit_pa1_stroke_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)




## MI - Female
plotHR2(fit_pa1_MI_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## Stroke - Male
plotHR2(fit_pa1_stroke_sa3_m,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)



## MI - Male
plotHR2(fit_pa1_MI_sa3_m,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
dev.off()



#######################################
# PA2
png("images/combined_sa3_pa2.png", width = 2200, height = 2250, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(2, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))
## Stroke - Female
plotHR2(fit_pa2_stroke_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)




## MI - Female
plotHR2(fit_pa2_MI_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## Stroke - Male
plotHR2(fit_pa2_stroke_sa3_m,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)



## MI - Male
plotHR2(fit_pa2_MI_sa3_m,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
dev.off()





#######################################
# PA3
png("images/combined_sa3_pa3.png", width = 2200, height = 2250, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(2, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))
## Stroke - Female
plotHR2(fit_pa3_stroke_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)




## MI - Female
plotHR2(fit_pa3_MI_sa3,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgreen", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## Stroke - Male
plotHR2(fit_pa3_stroke_sa3_m,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (Stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)



## MI - Male
plotHR2(fit_pa3_MI_sa3_m,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)
dev.off()


```
















## Sensitivity analysis 4 - 2 years of survival 
We perform a sensitivity analysis by first extracting people that have had a stroke or MI
within the 2 following years of the end of the accelerometer tracking ('2_years_survival_stroke' == 0;
or, 2_years_survival_MI' == 0)

Remove people who have had a Stroke or MI within 2 years following date_end_accel:
```{r}

# we create a new df where we extracted the participants for whom '2_years_survival_stroke' == 0
dt_sa4 <- dt %>%
  filter(`2_years_survival_stroke` != 0)

dt_sa4 <- dt_sa4  %>%
  filter(`2_years_survival_MI` != 0)

```

### Stroke
```{r}
# PA1
fit_pa1_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish  , data = dt_sa4 )

# PA2
fit_pa2_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish , data = dt_sa4 )

# PA3
fit_pa3_stroke_sa4 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish , data = dt_sa4 )



```


### MI
```{r}
# PA1
fit_pa1_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish , data = dt_sa4)

# PA2
fit_pa2_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish, data = dt_sa4)

# PA3
fit_pa3_MI_sa4 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + Race + deprivation_index + Education + hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + non_oily_fish, data = dt_sa4)


```


#### Combined Plots
```{r}
png("images/combined_sa4_scaled.png",width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

# PA1
## Stroke
plotHR2(fit_pa1_stroke_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa1_MI_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2
plotHR2(fit_pa2_stroke_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa2_MI_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3
## Stroke
plotHR2(fit_pa3_stroke_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa3_MI_sa4,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()


```


## Sensitivity analysis 5 - Forrest Plots

In the "3_survival_analysis_prep.Rmd" file



























## Sensitivity analysis 6 - Including Mediator (w/o PA4)

### Stroke
```{r}
# PA1
fit_pa1_stroke_sa6 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + bmi + type_2_diab + Depression, data = dt3)


# PA2
fit_pa2_stroke_sa6<- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + bmi + type_2_diab + Depression, data = dt3)

#fit_pa2_stroke_nk4_sa1 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa2, 4) + Sex + Age + ethnicity +  deprivation_index + Education +  hh_income + Smoking + Alcohol +processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish, data = dt)


#PA3
fit_pa3_stroke_sa6 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish + bmi + type_2_diab + Depression, data = dt3)

```

### MI
```{r}
# PA1
fit_pa1_MI_sa6 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + bmi + type_2_diab + Depression, data = dt3)


# PA2
fit_pa2_MI_sa6<- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish + bmi + type_2_diab + Depression, data = dt3)


#PA3
fit_pa3_MI_sa6 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3, 3) + Sex + Age + ethnicity +  deprivation_index + education_level +  avg_hh_income + smoking + alcohol + processed_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish + bmi + type_2_diab + Depression, data = dt3)

```

#### Combined Plots
```{r}
png("images/combined_sa6_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

# PA1
## Stroke
plotHR2(fit_pa1_stroke_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa1_MI_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2
plotHR2(fit_pa2_stroke_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa2_MI_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3
## Stroke
plotHR2(fit_pa3_stroke_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

## MI
plotHR2(fit_pa3_MI_sa6,
      rescaleHR = T, 
             term = 1,
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()


```





# Sensitivity analysis 7 - clinical variables 
### Stroke
```{r}


dt5 <- dt_original %>% rename(fu_time = `Follow up time in months`,
                    MI = `Myocardial infarction`,
                    mvpa1 = `MVPA min/week - ENMO`,
                    mvpa2 = `MVPA min/week - Machine learning`,
                    mvpa3 = `MVPA min/week - Activity count`,
                    deprivation_index = `Deprivation index`,
  hh_income = `Household income GBP`,
                    Alcohol = `Alcohol consumption`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`,
  SBP = `Systolic blood pressure`,
DBP = `Diastolic blood pressure`,
HDC = `HDL cholesterol`,
BLG = `Blood glucose (biochemistry)`,
TG = `Triglycerides (baseline)`,
CRP = `C-reactive protein (baseline)`
                    )




dt5$SBP %>% hist()
dt5$DBP %>%  hist()
dt5$HDC %>% hist()
dt5$BLG %>%  hist()
dt5$TG %>% hist()
dt5$CRP %>% hist()



# PA1
fit_pa1_stroke_sa7 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + SBP + DBP + HDC + BLG + TG + CRP, data = dt5)

# PA2
fit_pa2_stroke_sa7<- coxph(Surv(fu_time, Stroke) ~ mvpa2 + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP, data = dt5)

#PA3
fit_pa3_stroke_sa7 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP , data = dt5)

```


### MI

```{r}
# PA1
fit_pa1_mi_sa7 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP, data = dt5)

# PA2
fit_pa2_mi_sa7 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP , data = dt5)

#PA3
fit_pa3_mi_sa7 <- coxph(Surv(fu_time, MI) ~ mvpa3 + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish +red_meat + non_oily_fish + SBP + DBP + HDC + BLG + TG + CRP , data = dt5)


```


#### Combined Plots

6 plots PA1-3, sameas main, except using dt2, in one figure
```{r}
png("images/combined_sa7_PA13_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

source("plotHR_hiroshiFunction.R")
# PA1
plotHR2(fit_pa1_stroke_sa7,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA1 MI
plotHR2(fit_pa1_mi_sa7,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA2
plotHR2(fit_pa2_stroke_sa7,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA2 MI
plotHR2(fit_pa2_mi_sa7,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3
## Stroke
plotHR2(fit_pa3_stroke_sa7,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa3_mi_sa7,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()
```



# Sensitivity analysis 8
## Stroke
```{r}


dt8 <- dt8 %>% rename(fu_time = `Follow up time in months`,
                    MI = `Myocardial infarction`,
                    mvpa1_100 = `MVPA min/week - ENMO (100g)`,
                    mvpa1_150 = `MVPA min/week - ENMO (150g)`,
                    mvpa2 = `MVPA min/week - Machine learning`,
                    mvpa3_v2 = `MVPA min/week - Activity count`,
                    deprivation_index = `Deprivation index`,
                    hh_income = `Household income GBP`,
                    Alcohol = `Alcohol consumption`,
                    pro_meat = `Processed meat`,
                    red_meat = `Red meat`,
                    fresh_fruit = `Fresh fruit`,
                    cooked_vg = `Cooked vegetables`,
                    oily_fish = `Oily fish`,
                    non_oily_fish = `Non-oily fish`,
                    SBP = `Systolic blood pressure`,
                    DBP = `Diastolic blood pressure`,
                    HDC = `HDL cholesterol`,
                    BLG = `Blood glucose (biochemistry)`,
                    TG = `Triglycerides (baseline)`,
                    CRP = `C-reactive protein (baseline)`
                    )

```

```{r}
par(mfrow = c(2,2))  # Set up a 2x2 plotting grid
hist(dt8$mvpa1_100, main = "Dt8, MVPA_100") 
hist(dt8$mvpa1_150, main = "Dt8, MVPA_150") 
hist(dt8$mvpa3_v2, main = "Dt8, MVPA3_v2") 


# PA1 100g
fit_pa100_stroke_sa8 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1_100, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + SBP + DBP + HDC + BLG + TG + CRP, data = dt8)

# PA1 150g
fit_pa150_stroke_sa8<- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa1_150, 3)  + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP, data = dt8)

# PA3 v2
fit_pa3_v2_stroke_sa8 <- coxph(Surv(fu_time, Stroke) ~ rcs(mvpa3_v2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP , data = dt8)


```

## MI
```{r}
# PA1 100g
fit_pa100_MI_sa8 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa1_100, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat + non_oily_fish + SBP + DBP + HDC + BLG + TG + CRP, data = dt8)

# PA1 150g
fit_pa150_MI_sa8<- coxph(Surv(fu_time, MI) ~ rcs(mvpa1_150, 3)  + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP, data = dt8)

# PA3 v2
fit_pa3_v2_MI_sa8 <- coxph(Surv(fu_time, MI) ~ rcs(mvpa3_v2, 3) + Sex + Age + Race +  deprivation_index + Education +  hh_income + Smoking + Alcohol + pro_meat + fresh_fruit + cooked_vg + oily_fish + red_meat +non_oily_fish  + SBP + DBP + HDC + BLG + TG + CRP , data = dt8)


```



### Combined plots for sensitivity analysis 8
```{r}


png("/home/yacine/AcclerometerProcessing/combined_sa8_PA13_scaled.png", width = 2250, height = 2625, res = 300)
par(family = "Arial", ps = 12, cex = 1, mfrow = c(3, 2), oma = c(0, 0, 2, 0), mar = c(4, 4, 2, 1))

source("plotHR_hiroshiFunction.R")
# PA1 - 100g Stroke
plotHR2(fit_pa100_stroke_sa8,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("A", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA1 - 100g MI
plotHR2(fit_pa100_MI_sa8,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("B", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

# PA1 - 150g Stroke
plotHR2(fit_pa150_stroke_sa8,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (stroke)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("C", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA1 - 150g MI
plotHR2(fit_pa150_stroke_sa8,
       term = 1,
      rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 1500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("D", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


# PA3 - v2
## Stroke
plotHR2(fit_pa3_v2_stroke_sa8,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 2500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("E", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)


## MI
plotHR2(fit_pa3_v2_MI_sa8,
       term = 1,
       rescaleHR = T, 
     xlab = "MVPA (minutes/week)", 
     ylab = "Hazard ratio (MI)", 
     xlim = c(0, 2500), 
     ylim = c(0.1, 1.3), 
     plot.bty = "U", 
     cex.axis = 1, 
     cex.lab = 1.2, 
     lwd.term = 1.5,
     lty.term = 1,
     col.se = "lightgrey", 
     col.dens = "grey")
fig_label("F", pos = "topleft", cex = 1.5, x_adj = -0.1, y_adj = -0.03)

dev.off()
```




